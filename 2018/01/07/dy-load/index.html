<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="åšé…·çš„ä¸œè¥¿, æˆä¸ºä¼Ÿå¤§çš„å·¥ç¨‹å¸ˆï¼Œå†™åŒªå¤·æ‰€æ€çš„ä»£ç ï¼Œç„¶åå’Œæ¯ä¸ªäººæˆä¸ºæœ‹å‹ï¼"><title>å®‰å“å¹³å°ä¸­çš„åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ | å¸¸å…´ E ç«™</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="Bookmark" href="/favicon.ico"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">å®‰å“å¹³å°ä¸­çš„åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ</h1><a id="logo" href="/.">å¸¸å…´ E ç«™</a><p class="description">Action Speak Louder Than Words.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/sitemap.xml"><i class="fa fa-rss"> sitemap</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">å®‰å“å¹³å°ä¸­çš„åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ</h1><div class="post-meta">Jan 7, 2018<span> | </span><span class="category"><a href="/categories/android/">android</a></span></div><div class="post-content"><p>å®‰å“å¹³å°çš„åŠ¨æ€åŠ è½½åŸç†ï¼Œæœ¬è´¨å…¶å®è¿˜æ˜¯åˆ©ç”¨javaç›¸å…³çŸ¥è¯†å®ç°ã€‚ç„¶è€Œjavaè¯­è¨€ä¸­ï¼Œå¼€å‘äººå‘˜èƒ½é€šè¿‡ç¨‹åºè¿›è¡ŒåŠ¨æ€æ“ä½œclassçš„ï¼Œä¸»è¦æ˜¯å­—èŠ‚ç ç”Ÿæˆå’Œç±»åŠ è½½å™¨è¿™ä¸¤éƒ¨åˆ†çš„åŠŸèƒ½ã€‚æœ¬æ–‡ä¸­ä¹Ÿä¸»è¦æ˜¯å›´ç»•è¿™ä¸¤æ–¹é¢çš„æŠ€æœ¯ï¼Œå±•å¼€åœ¨å®‰å“å¹³å°ä¸Šçš„åº”ç”¨åˆ†æã€‚</p>
<p>é˜…è¯»æœ¬æ–‡ï¼Œä¸€èµ·å®è§‚ç†è§£å®‰å“æ’ä»¶åŒ–ï¼Œçƒ­ä¿®å¤ï¼Œæ¨¡å—åŒ–ï¼ŒAOPï¼ŒJavaç±»åŠ è½½ç­‰çŸ¥è¯†ã€‚</p>
<a id="more"></a>
<h1 id="åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ"><a href="#åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ" class="headerlink" title="åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ"></a>åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ</h1><h2 id="ä¸€ã€JavaåŸºç¡€çŸ¥è¯†"><a href="#ä¸€ã€JavaåŸºç¡€çŸ¥è¯†" class="headerlink" title="ä¸€ã€JavaåŸºç¡€çŸ¥è¯†"></a>ä¸€ã€JavaåŸºç¡€çŸ¥è¯†</h2><h3 id="1ã€è™šæ‹Ÿæœºç±»çš„åŠ è½½å‰–æ"><a href="#1ã€è™šæ‹Ÿæœºç±»çš„åŠ è½½å‰–æ" class="headerlink" title="1ã€è™šæ‹Ÿæœºç±»çš„åŠ è½½å‰–æ"></a>1ã€è™šæ‹Ÿæœºç±»çš„åŠ è½½å‰–æ</h3><p>Javaè™šæ‹ŸæœºæŠŠæè¿°ç±»çš„æ•°æ®ä»Classæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¯¹æ•°æ®è¿›è¡Œæ ¡éªŒã€è½¬åŒ–è§£æå’Œåˆå§‹åŒ–ï¼Œæœ€ç»ˆå½¢æˆè¢«è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨çš„Javaç±»å‹ï¼Œå®Œæˆäº†ç±»çš„åŠ è½½æœºåˆ¶ã€‚</p>
<p>ç±»å‹çš„åŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–éƒ½æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶æœŸé—´å®Œæˆçš„ï¼Œè™½ç„¶ä¼šåœ¨åˆæ¬¡åŠ è½½è€—ä¸€å®šæ€§èƒ½ï¼Œä½†æ˜¯æ­£æ˜¯è¿™ä¸ªæœºåˆ¶ä¸ºJavaæä¾›é«˜åº¦çš„åŠ¨æ€æ‰©å±•çµæ´»æ€§ã€‚å¦‚å¯ä»¥ç¼–å†™ä¸€ä¸ªé¢å‘æ¥å£çš„åº”ç”¨ç¨‹åºï¼Œè¿è¡Œæ—¶å†å†³å®šå®é™…çš„å®ç°ç±»ï¼Œå®ç°ç±»å¯ä»¥ä»æœ¬åœ°æˆ–æ˜¯ç½‘ç»œåŠ¨æ€åŠ è½½ã€‚</p>
<p>ç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜åˆ°ä»å†…å­˜ä¸­å¸è½½ï¼Œå®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼šåŠ è½½ï¼ˆloadingï¼‰ã€éªŒè¯ï¼ˆVerificationï¼‰ã€å‡†å¤‡ï¼ˆPreparationï¼‰ã€è§£æï¼ˆResolutionï¼‰ã€åˆå§‹åŒ–ï¼ˆInitializationï¼‰ã€ä½¿ç”¨ï¼ˆUsingï¼‰ã€å’Œå¸è½½ï¼ˆUnLoadingï¼‰ä¸ƒä¸ªé˜¶æ®µï¼Œå…¶ä¸­éªŒè¯ã€å‡†å¤‡ã€è§£æç»Ÿç§°ä¸ºè¿æ¥ï¼ˆLinkingï¼‰ã€‚<br>è¿™é‡Œä¸»è¦åˆ†æä¸‹åŠ è½½é˜¶æ®µï¼š</p>
<p><em>â€˜åŠ è½½â€™</em>æ˜¯<em>â€˜ç±»åŠ è½½â€™</em>è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªé˜¶æ®µï¼Œä¸»è¦å®Œæˆä¸‰ä»¶äº‹ï¼š1ï¼‰é€šè¿‡ç±»çš„å…¨é™å®šåæ¥è·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµã€‚2ï¼‰å°†è¿™ä¸ªå­—èŠ‚æµæ‰€ä»£è¡¨çš„é™æ€å‚¨å­˜ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ã€‚3ï¼‰åœ¨å†…å­˜ä¸­ç”Ÿæˆæ­¤ç±»ç›¸åº”Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºè¿™ä¸ªç±»çš„å„ç§æ•°æ®çš„è®¿é—®å…¥å£ã€‚</p>
<p>è™šæ‹Ÿæœºè§„å®šåŠ è½½ä¸€ä¸ªç±»åœ¨åŠ è½½é˜¶æ®µéœ€è¦èƒ½â€œé€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåè·å–æ­¤ç±»äºŒè¿›åˆ¶å­—èŠ‚æµâ€ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§„å®šè¦ä»å“ªé‡Œã€æ€æ ·è·å–ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ä»ZIPä¸­è¯»å–ï¼Œå¦‚ï¼šjarï¼Œdexç­‰ã€‚</li>
<li>ç½‘ç»œæµä¸­è·å–ï¼Œå¦‚Appletã€‚</li>
<li>è¿è¡Œæ—¶è®¡ç®—ç”Ÿæˆï¼Œå¦‚åŠ¨æ€ä»£ç†ã€‚</li>
<li>æœ‰å…¶ä»–æ–‡ä»¶ç”Ÿæˆã€æ•°æ®åº“ä¸­è¯»å–ç­‰ã€‚</li>
<li>â€¦</li>
</ul>
<p>è¿™æ ·ï¼Œå¼€å‘äººå‘˜å°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ï¼Œæˆ–æ˜¯hookç³»ç»Ÿç±»åŠ è½½å™¨æ¥æ§åˆ¶å­—èŠ‚æµçš„è·å–æ–¹å¼ã€‚</p>
<p>ç±»çš„æ˜¾å¼åŠ è½½ï¼ˆClass.forNameï¼‰å’Œéšå¼åŠ è½½ï¼ˆå¦‚ï¼šnewï¼‰ä¸¤ç§åŠ è½½æ–¹å¼ï¼Œæœ€åéƒ½ä¼šè°ƒç”¨ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•æ¥å®Œæˆç±»çš„å®é™…åŠ è½½å·¥ä½œã€‚</p>
<p><img src="dl1.png" alt="åŒäº²å§”æ‰˜æ¨¡å‹"></p>
<p>ç±»çš„åŠ è½½å™¨å…·æœ‰åŒäº²å§”æ‰˜æ¨¡å‹ï¼Œè¯¥ç‰¹æ€§ä¿è¯äº†Javaç¨‹åºçš„å®‰å…¨æ€§ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯è™šæ‹Ÿæœºå¼ºåˆ¶è§„å®šçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½æœºåˆ¶ï¼Œæ¥ç ´åè¿™ç§æœºåˆ¶ã€‚å¦‚å®‰å“æ’ä»¶åŠ è½½ï¼Œçƒ­ä¿®åŠOSGIæ¨¡å—åŒ–åŠ¨æ€åŠ è½½ä¸­çš„ç±»åŠ è½½æŠ€æœ¯åº”ç”¨ã€‚</p>
<h3 id="2ã€é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰"><a href="#2ã€é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰" class="headerlink" title="2ã€é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰"></a>2ã€é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰</h3><p>Javaé¢å¯¹å¯¹è±¡çš„è¯­è¨€ï¼Œå¹³æ—¶ç”¨çš„æœ€å¤šçš„å°±æ˜¯OOPï¼ˆé¢å¯¹å¯¹è±¡ç¼–ç¨‹ï¼‰ï¼Œç„¶ååœ¨å¾ˆå¤šæŠ€æœ¯ç ”å‘ä¸­ï¼ˆå¦‚å®‰å“åŠ¨æ€åŠ è½½ï¼Œæ€§èƒ½ç›‘æ§ï¼Œæ—¥å¿—ç­‰ï¼‰æ…¢æ…¢çš„æ¥è§¦åˆ°ä¸€ä¸ªæ–°çš„åæ¬¡<strong>â€œAOPâ€</strong>ï¼ŒGoogleè¿‡åï¼Œæ‰å‘ç°è¿™æ˜¯ä¸€ç§å¾ˆç‰¹åˆ«ã€å¾ˆå¼ºå¤§ã€å¾ˆé«˜çº§å®ç”¨çš„ç¼–ç¨‹æ–¹å¼ã€‚ç™¾åº¦ç™¾ç§‘è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>AOPä¸ºAspect Oriented Programmingçš„ç¼©å†™ï¼Œæ„ä¸ºï¼šé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œé€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†å®ç°ç¨‹åºåŠŸèƒ½çš„ç»Ÿä¸€ç»´æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚AOPæ˜¯OOPçš„å»¶ç»­ï¼Œæ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸€ä¸ªçƒ­ç‚¹ï¼Œä¹Ÿæ˜¯Springæ¡†æ¶ä¸­çš„ä¸€ä¸ªé‡è¦å†…å®¹ï¼Œæ˜¯å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ç§è¡ç”ŸèŒƒå‹ã€‚åˆ©ç”¨AOPå¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾—ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚</p>
</blockquote>
<p>å…¶å®AOPç¼–ç¨‹æ¨¡å¼å·²ç»å­˜åœ¨å¾ˆå¤šå¹´ç±»ï¼Œå¹¶ä¸”åœ¨Androidé¡¹ç›®å¼€å‘ä¸­ä¹Ÿæœ‰å¾ˆå¤šåœ°æ–¹çš„åº”ç”¨ï¼Œæœ‰å¾ˆå¤šä¼˜ç§€ä¸”æµè¡Œçš„å·¥å…·å¦‚APTï¼ŒAspectJ, Javassistç­‰ï¼Œä¸ºæˆ‘ä»¬AOPå¼€å‘æä¾›äº†ä¾¿åˆ©å®ç°ã€‚</p>
<p>ä¸åŒçš„å·¥å…·åº“ä½œç”¨åœ¨ä¸åŒçš„é˜¶æ®µï¼Œè¿™é‡Œå¼•ç”¨ç½‘ç»œä¸Šä¸€å¼ å›¾ï¼Œå¯ä»¥è¯´æ˜ä¸‰è€…é—´çš„åŒºåˆ«ã€‚</p>
<p><img src="dl2.jpeg" alt="AOP-å¼•ç”¨è‡ªç½‘ç»œ"></p>
<p><strong>APT</strong></p>
<p>APT(Annotation Processing Tooï¼‰åº”è¯¥éƒ½å¬è¿‡å¹¶ä¸”ç”¨è¿‡ï¼Œæ¦‚å¿µæ¯”è¾ƒå¥½ç†è§£ï¼Œä¸»è¦ä½œç”¨åœ¨ç¼–è¯‘æœŸï¼Œä¹Ÿæ˜¯æ¯”è¾ƒæµè¡Œä¸”å¸¸è§çš„æŠ€æœ¯ã€‚</p>
<p>ä»£ç ç¼–è¯‘æœŸè§£ææ³¨è§£åï¼Œç»“åˆsquareå…¬å¸çš„å¼€æºé¡¹ç›®javapoeté¡¹ç›®ï¼Œç”Ÿæˆè‡ªå®šé€»è¾‘çš„javaæºç ã€‚æœ‰å¾ˆå¤šå¼€æºåº“éƒ½åœ¨ç”¨å¦‚ï¼šButterKnifeã€EventBusç­‰ã€‚</p>
<p><strong>AspectJ</strong></p>
<p>AspectJæ”¯æŒç¼–è¯‘æœŸå’ŒåŠ è½½æ—¶ä»£ç æ³¨å…¥, æœ‰ä¸€ä¸ªä¸“é—¨çš„ç¼–è¯‘å™¨ç”¨æ¥ç”Ÿæˆéµå®ˆJavaå­—èŠ‚ç¼–ç è§„èŒƒçš„Classæ–‡ä»¶ã€‚æ›´å¤šç»†èŠ‚å¯ä»¥çœ‹<a href="https://www.jianshu.com/p/0fa8073fd144" target="_blank" rel="external">è¿™é‡Œ</a>ã€‚</p>
<p><strong>Javassist</strong></p>
<p>Javassistæ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç çš„ç±»åº“ã€‚å…è®¸å¼€å‘è€…è‡ªç”±çš„åœ¨ä¸€ä¸ªå·²ç»ç¼–è¯‘å¥½çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä¿®æ”¹å·²æœ‰çš„æ–¹æ³•ï¼Œå…è®¸å¼€å‘è€…å¿½ç•¥è¢«ä¿®æ”¹çš„ç±»æœ¬èº«çš„ç»†èŠ‚å’Œç»“æ„ã€‚</p>
<p>360å¼€æºæ’ä»¶é¡¹ç›®<a href="https://github.com/Qihoo360/RePlugin" target="_blank" rel="external">RePlugin</a>ä¸­ï¼Œä¸ºäº†å‡å°‘å¯¹å®‰å“ç³»ç»Ÿçš„Hookç‚¹ï¼Œåˆå¸Œæœ›è§£è€¦å¼€å‘å±‚ä»£ç é€»è¾‘ï¼Œå…¶ä¸­å°±ç”¨åˆ°äº†<em>Javassist</em>æŠ€æœ¯ã€‚</p>
<h2 id="äºŒã€æ’ä»¶åŒ–æŠ€æœ¯åˆ†æ"><a href="#äºŒã€æ’ä»¶åŒ–æŠ€æœ¯åˆ†æ" class="headerlink" title="äºŒã€æ’ä»¶åŒ–æŠ€æœ¯åˆ†æ"></a>äºŒã€æ’ä»¶åŒ–æŠ€æœ¯åˆ†æ</h2><p>å®‰å“é¡¹ç›®å‘å±•æ—©èµ·ï¼Œå¯èƒ½æœ€åˆåªæ˜¯ä¸ºäº†è§£å†³65535é—®é¢˜åŠåŒ…å¤§å°ï¼Œå„å®¶å…¬å¸éƒ½åœ¨ç ”ç©¶å®‰å“å¹³å°åŠ¨æ€åŠ è½½ï¼Œä¹Ÿå°±æ˜¯ç°åœ¨æ‰€è°“çš„æ’ä»¶åŒ–è§£å†³æ–¹æ¡ˆã€‚</p>
<p>ä»14å¹´çš„<em>Dynamic-load-apk</em>å¼€æºé¡¹ç›®ï¼Œåˆ°ç°åœ¨ï¼ˆ17å¹´ï¼‰çš„<em>RePlugin</em>åŠ<em>VirtualAPK</em>ï¼Œåˆ†æä¸‹å®ç°åŸç†ï¼Œä¸ªäººç†è§£ï¼Œå…¶å®å¹¶ä¸æ˜¯å¾ˆéš¾ï¼Œæ— éå°±æ˜¯åˆ©ç”¨é™æ€ä»£ç†ã€åŠ¨æ€ä»£ç†ï¼Œåå°„ï¼ŒHOOKåŠClassLoaderï¼ˆdexåˆå¹¶ï¼Œæˆ–åŒäº²å§”æ‰˜ç ´åï¼‰ç­‰ç›¸å…³æŠ€æœ¯å¯¹å®‰å“å››å¤§ç»„ä»¶çš„æ²™ç›’å®ç°ã€‚</p>
<p>å½“ç„¶çœŸæ­£çš„éš¾ç‚¹åœ¨äºå¯¹åƒä¸‡å®‰å“æœºå‹åŠRomçš„é€‚é…ï¼ŒåŠå®Œæ•´å®‰å“åŠŸèƒ½çš„å…¼å®¹å®ç°ï¼Œä¸å¯å¦è®¤æ’ä»¶åŒ–å¤§ç‰›åœ¨å®‰å“è¡Œä¸šå‘å±•çš„å·¨å¤§è´¡çŒ®ï¼ˆæ„Ÿè°¢å„ä½å¼€æºå¤§ä½¬ğŸ™ï¼‰ã€‚</p>
<p>æ—¢ç„¶å·²ç»æœ‰å¾ˆå¤šä¼˜ç§€çš„å¼€æºåº“ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦è¿˜æœ‰å¿…è¦å­¦ä¹ å®ƒå‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚</p>
<p>ä¸ªäººè®¤ä¸ºï¼Œå­¦ä¹ æ’ä»¶åŒ–æ˜¯ä¸€åå®‰å“å¼€å‘ï¼Œæ¥è§¦ç³»ç»Ÿæºç ï¼Œç‰¢å›ºå®‰å“çŸ¥è¯†ï¼Œæå‡å¼€å‘æŠ€èƒ½å¾—è‰¯å¥½é€”å¾„ã€‚æ¨èå¯ä»¥å¥½å¥½å­¦ä¹ ä¸‹15å¹´æœ€æ—©å¼€æº<a href="https://github.com/Qihoo360/DroidPlugin" target="_blank" rel="external">DroidPlugin</a>é¡¹ç›®ï¼Œè™½ç„¶å’Œä»Šå¹´å¼€æºçš„<em>RePlugin</em>å’Œ<em>VirtualAPK</em>æ¯”ï¼Œæœ‰ä¸€å®šçš„å¤æ‚åŠå…¼å®¹å·®ï¼Œä½†æ˜¯åˆ†æåè€…å…¶å®è¿˜æ˜¯ä¼šæœ‰å‰è€…å®ç°æ€æƒ³ï¼ŒåŸºæœ¬ä¸Šä¸‡å˜ä¸ç¦»å…¶ç»¼ï¼ˆå¦‚activityçš„æ’ä»¶å®ç°ï¼Œéƒ½æ˜¯å å‘æ€æƒ³ï¼›éƒ½æ˜¯åœ¨startActivityåï¼Œåˆ©ç”¨ä¸€å®šæŠ€æœ¯æ‰‹æ®µåœ¨ä¸€å®šç‚¹æ›¿æ¢targeActivityï¼Œç­‰AMSå›è°ƒå›æ¥ï¼Œåœ¨æ‰¾ä¸€åˆé€‚ç‚¹ï¼Œæ¢å›åŸactivityï¼‰ã€‚ä¸ªäººç†è§£åè€…æ˜¯ä»ä¸åŒè§’åº¦å¯¹DroidPluginçš„å‡çº§åŠä¼˜åŒ–ã€‚</p>
<h2 id="ä¸‰ã€çƒ­ä¿®å¤"><a href="#ä¸‰ã€çƒ­ä¿®å¤" class="headerlink" title="ä¸‰ã€çƒ­ä¿®å¤"></a>ä¸‰ã€çƒ­ä¿®å¤</h2><p>å®‰å“æŠ€æœ¯å‘å±•ä¸­æœŸï¼Œæœ‰å¾ˆå¤šå¤§å‹APPï¼Œéœ€è¦ç´§æ€¥è§£å†³çº¿ä¸Šé—®é¢˜ï¼Œä¸šç•Œå¼€å§‹ç ”ç©¶çº¿ä¸Šçƒ­ä¿®å¤æŠ€æœ¯ã€‚</p>
<p>æœŸé—´ï¼ŒGoogleå®˜æ–¹ä¸ºäº†è§£å†³65535é—®é¢˜ï¼Œå‘å¸ƒäº†Multidexå¤šdexæ–¹æ¡ˆï¼Œåˆ©ç”¨Applicationç±»åŠ è½½åŠåˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œä»ä¸­attachContextæ—¶å€™ï¼ŒåŠ¨æ€åŠ è½½å¤šä¸ªdexã€‚å¹¶åœ¨Android Studio 2.0å‘å¸ƒäº†Intant Runå¿«é€Ÿä»£ç éƒ¨ç½²æ–¹æ¡ˆï¼ˆçƒ­æ’æ‹”ï¼‰ã€‚</p>
<p>è¿™ä¸ä½†ç»™æ’ä»¶åŒ–ç»™å‡ºç±»å€Ÿé‰´æ–¹æ¡ˆï¼Œä¹Ÿç»™çƒ­ä¿®æ”¹æä¾›äº†Javaå±‚çš„å¯è¡Œæ–¹æ¡ˆï¼ˆæ­¤æ–‡ä¸å±•å¼€Nativeå±‚çš„å®ç°åˆ†æï¼‰ã€‚å…·æœ‰ä»£è¡¨æ€§çš„é¡¹ç›®å¦‚ç¾å›¢çš„<a href="https://tech.meituan.com/android_robust.html" target="_blank" rel="external">çƒ­æ›´æ–°æ–¹æ¡ˆRobust</a>ã€‚</p>
<p>è¿™é‡Œç®€å•åˆ†æä¸‹Google intant Runå®ç°åŸç†</p>
<p>é€šè¿‡é˜…è¯»<a href="https://developer.android.com/studio/run/index.html?hl=zh-cn#cold-swap" target="_blank" rel="external">å®˜æ–¹æ–‡æ¡£</a>åŠæºç ï¼Œå¯çœ‹å‡ºå®˜æ–¹ä»£ç å¿«é€Ÿéƒ¨åˆ†å®šä¹‰äº†ä¸‰ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>çƒ­æ‹”æ’ï¼šä»£ç æ”¹å˜è¢«åº”ç”¨ã€æŠ•å°„åˆ°APPä¸Šï¼Œä¸éœ€è¦é‡å¯åº”ç”¨ï¼Œä¸éœ€è¦é‡å»ºå½“å‰activityã€‚åœºæ™¯ï¼šé€‚ç”¨äºå¤šæ•°çš„ç®€å•æ”¹å˜ï¼ˆåŒ…æ‹¬ä¸€äº›æ–¹æ³•å®ç°çš„ä¿®æ”¹ï¼Œæˆ–è€…å˜é‡å€¼ä¿®æ”¹ï¼‰</li>
<li>æ¸©æ‹”æ’ï¼šactivityéœ€è¦è¢«é‡å¯æ‰èƒ½çœ‹åˆ°æ‰€éœ€æ›´æ”¹ã€‚åœºæ™¯ï¼šå…¸å‹çš„æƒ…å†µæ˜¯ä»£ç ä¿®æ”¹æ¶‰åŠåˆ°äº†èµ„æºæ–‡ä»¶ï¼Œå³resã€‚</li>
<li>å†·æ‹”æ’ï¼šappéœ€è¦è¢«é‡å¯ï¼ˆä½†æ˜¯ä»ç„¶ä¸éœ€è¦é‡æ–°å®‰è£…ï¼‰åœºæ™¯ï¼šä»»ä½•æ¶‰åŠç»“æ„æ€§å˜åŒ–çš„ï¼Œæ¯”å¦‚ï¼šä¿®æ”¹äº†ç»§æ‰¿è§„åˆ™ã€ä¿®æ”¹äº†æ–¹æ³•ç­¾åç­‰ã€‚</li>
</ul>
<p>æœä¸‹Intant Run Serveræºç ä¼šå‘ç°ä»£ç æ›´æ–°æ–¹å¼é€»è¾‘å¦‚ä¸‹ï¼š</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">int</span> handlePatches(List&lt;ApplicationPatch&gt; changes,</div><div class="line">        <span class="keyword">boolean</span> hasResources, <span class="keyword">int</span> updateMode) &#123;</div><div class="line">    <span class="keyword">if</span> (hasResources) &#123;</div><div class="line">        FileManager.startUpdate();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (ApplicationPatch <span class="string">change :</span> changes) &#123;</div><div class="line">        String path = change.getPath();</div><div class="line">        <span class="keyword">if</span> (path.endsWith(<span class="string">".dex"</span>)) &#123;</div><div class="line">            handleColdSwapPatch(change);<span class="comment">//å†·æ‹”æ’</span></div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> canHotSwap = <span class="literal">false</span>;</div><div class="line">            <span class="keyword">for</span> (ApplicationPatch <span class="string">c :</span> changes) &#123;</div><div class="line">                <span class="keyword">if</span> (c.getPath().equals(<span class="string">"classes.dex.3"</span>)) &#123;</div><div class="line">                    canHotSwap = <span class="literal">true</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!canHotSwap) &#123;</div><div class="line">                updateMode = <span class="number">3</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (path.equals(<span class="string">"classes.dex.3"</span>)) &#123;</div><div class="line">            updateMode = handleHotSwapPatch(updateMode, change);<span class="comment">//çƒ­æ‹”æ’</span></div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isResourcePath(path)) &#123;</div><div class="line">            updateMode = handleResourcePatch(updateMode, change, path);<span class="comment">//æ¸©æ‹”æ’</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (hasResources) &#123;</div><div class="line">        FileManager.finishUpdate(<span class="literal">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> updateMode;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸»è¦åˆ†æä¸‹æ¶‰åŠåˆ°ä»£ç æ›´æ–°çš„çƒ­æ’æ‹”å’Œå†·æ’æ‹”ã€‚åˆ†æä»£ç è¿‡ç¨‹ä¸»è¦æ˜¯åç¼–é€šè¿‡Intant Runä¸ºæˆ‘ä»¬ç”Ÿæˆçš„Apkï¼Œç„¶åé¡ºè—¤æ‘¸ç“œã€‚</p>
<p>é¦–å…ˆçœ‹è¿™ä¸ªå£³å­APKçš„Applicationéƒ½å¹²äº†ä»€ä¹ˆï¼Œåˆ†æä¸‹å£³å­APKæ˜¯æ€ä¹ˆå¯åŠ¨æˆ‘ä»¬çœŸæ­£çš„Appçš„ã€‚</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> attachBaseContext(Context context) &#123;</div><div class="line">      <span class="keyword">if</span> (!AppInfo.usingApkSplits) &#123;</div><div class="line">          String apkFile = context.getApplicationInfo().sourceDir;</div><div class="line">          <span class="keyword">long</span> apkModified = apkFile != <span class="keyword">null</span> ? <span class="keyword">new</span> <span class="keyword">File</span>(apkFile)</div><div class="line">                  .lastModified() : <span class="number">0</span>L;</div><div class="line">          createResources(apkModified);</div><div class="line">          setupClassLoaders(context, context.getCacheDir().getPath(),</div><div class="line">                  apkModified);</div><div class="line">      &#125;</div><div class="line">      createRealApplication();</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              Method attachBaseContext = ContextWrapper.<span class="keyword">class</span></div><div class="line">                      .getDeclaredMethod(<span class="string">"attachBaseContext"</span>,</div><div class="line">                              <span class="keyword">new</span> <span class="keyword">Class</span>[] &#123; Context.<span class="keyword">class</span> &#125;);</div><div class="line">              attachBaseContext.setAccessible(<span class="keyword">true</span>);</div><div class="line">              attachBaseContext.invoke(<span class="keyword">this</span>.realApplication,</div><div class="line">                      <span class="keyword">new</span> Object[] &#123; context &#125;);</div><div class="line">          &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">private</span> <span class="keyword">void</span> createResources(<span class="keyword">long</span> apkModified) &#123;</div><div class="line">      <span class="keyword">File</span> <span class="keyword">file</span> = FileManager.getExternalResourceFile();</div><div class="line">      <span class="keyword">this</span>.externalResourcePath = (<span class="keyword">file</span> != <span class="keyword">null</span> ? <span class="keyword">file</span>.getPath() : <span class="keyword">null</span>);</div><div class="line">     </div><div class="line">      <span class="keyword">if</span> (<span class="keyword">file</span> != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              <span class="keyword">long</span> resourceModified = <span class="keyword">file</span>.lastModified();</div><div class="line">             </div><div class="line">              <span class="keyword">if</span> ((apkModified == <span class="number">0</span>L) || (resourceModified &lt;= apkModified)) &#123;</div><div class="line">                  <span class="keyword">if</span> (Log.isLoggable(<span class="string">"InstantRun"</span>, <span class="number">2</span>)) &#123;</div><div class="line">                      Log.v(<span class="string">"InstantRun"</span>,</div><div class="line">                              <span class="string">"Ignoring resource file, older than APK"</span>);</div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">this</span>.externalResourcePath = <span class="keyword">null</span>;</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">              Log.e(<span class="string">"InstantRun"</span>, <span class="string">"Failed to check patch timestamps"</span>, t);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> setupClassLoaders(Context context, String codeCacheDir,</div><div class="line">                                        <span class="keyword">long</span> apkModified) &#123;</div><div class="line">      List dexList = FileManager.getDexList(context, apkModified);</div><div class="line">      <span class="keyword">Class</span> server = Server.<span class="keyword">class</span>;</div><div class="line">      <span class="keyword">Class</span> patcher = MonkeyPatcher.<span class="keyword">class</span>;</div><div class="line">      <span class="keyword">if</span> (!dexList.isEmpty()) &#123;</div><div class="line">          ClassLoader classLoader = BootstrapApplication.<span class="keyword">class</span></div><div class="line">                  .getClassLoader();</div><div class="line">          String nativeLibraryPath;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              nativeLibraryPath = (String) classLoader.getClass()</div><div class="line">                      .getMethod(<span class="string">"getLdLibraryPath"</span>, <span class="keyword">new</span> <span class="keyword">Class</span>[<span class="number">0</span>])</div><div class="line">                      .invoke(classLoader, <span class="keyword">new</span> Object[<span class="number">0</span>]);</div><div class="line">              <span class="keyword">if</span> (Log.isLoggable(<span class="string">"InstantRun"</span>, <span class="number">2</span>)) &#123;</div><div class="line">                  Log.v(<span class="string">"InstantRun"</span>, <span class="string">"Native library path: "</span></div><div class="line">                          + nativeLibraryPath);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">              nativeLibraryPath = FileManager.getNativeLibraryFolder()</div><div class="line">                      .getPath();</div><div class="line">          &#125;</div><div class="line">          IncrementalClassLoader.<span class="keyword">inject</span>(classLoader, nativeLibraryPath,</div><div class="line">                  codeCacheDir, dexList);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ€åä¼šæœ‰ä¸ªIncrementalClassLoaderï¼Œå½“å‰PathClassLoaderå§”æ‰˜IncrementalClassLoaderåŠ è½½dexã€‚ä»£ç å†·éƒ¨ç½²æ–¹æ¡ˆä¸­ï¼Œå½“APKè¿›ç¨‹é‡å¯æ—¶ï¼ŒIncrementalClassLoaderä¼šä¼˜å…ˆåŠ è½½éƒ¨ç½²çš„å˜æ›´ä»£ç ã€‚<br>åˆ†ææºç çœ‹å‡ºå®ƒçš„ç»“æ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="dl3.png" alt="å¼•ç”¨ç½‘ç»œå›¾ç‰‡"></p>
<p>createRealApplicationæ–¹æ³•åˆ›å»ºå‡ºçœŸæ­£çš„Applicationï¼Œå¯åŠ¨çœŸæ­£Dexæ–¹å¼å’Œä¸Šé¢æ’ä»¶åŒ–æ€æƒ³æœ‰ç‚¹ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå£³å­åŠ¨æ€åŠ è½½ä»£ç çš„å¾ˆå¥½ä¾‹å­ã€‚</p>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> void createRealApplication() &#123;</div><div class="line">    <span class="keyword">if</span> (AppInfo.applicationClass != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">Log</span>.isLoggable(<span class="string">"InstantRun"</span>, <span class="number">2</span>)) &#123;</div><div class="line">            <span class="built_in">Log</span>.v(<span class="string">"InstantRun"</span>,</div><div class="line">                    <span class="string">"About to create real application of class name = "</span></div><div class="line">                            + AppInfo.applicationClass);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="class"><span class="keyword">Class</span> <span class="title">realClass</span> = (<span class="title">Class</span>) <span class="title">Class</span></span></div><div class="line">                    .forName(AppInfo.applicationClass);</div><div class="line">            <span class="keyword">if</span> (<span class="built_in">Log</span>.isLoggable(<span class="string">"InstantRun"</span>, <span class="number">2</span>)) &#123;</div><div class="line">                <span class="built_in">Log</span>.v(<span class="string">"InstantRun"</span>,</div><div class="line">                        <span class="string">"Created delegate app class successfully : "</span></div><div class="line">                                + realClass + <span class="string">" with class loader "</span></div><div class="line">                                + realClass.getClassLoader());</div><div class="line">            &#125;</div><div class="line">            Constructor constructor = realClass</div><div class="line">                    .getConstructor(<span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>[0]);</span></div><div class="line">            this.realApplication = ((Application) constructor</div><div class="line">                    .newInstance(<span class="keyword">new</span> Object[<span class="number">0</span>]));</div><div class="line">            <span class="keyword">if</span> (<span class="built_in">Log</span>.isLoggable(<span class="string">"InstantRun"</span>, <span class="number">2</span>)) &#123;</div><div class="line">                <span class="built_in">Log</span>.v(<span class="string">"InstantRun"</span>,</div><div class="line">                        <span class="string">"Created real app instance successfully :"</span></div><div class="line">                                + this.realApplication);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        this.realApplication = <span class="keyword">new</span> Application();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœŸæ­£çš„Applicationåˆ›å»ºåï¼Œæ¥ä¸‹æ¥å†åˆ†æä¸‹å˜æ›´çš„ä»£ç æ˜¯å¦‚ä½•çƒ­æ›´æ–°ç”Ÿæ•ˆçš„ï¼Ÿ</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">void</span> onCreate() &#123;</div><div class="line">      <span class="keyword">if</span> (!AppInfo.usingApkSplits) &#123;</div><div class="line">          MonkeyPatcher.monkeyPatchApplication(<span class="keyword">this</span>, <span class="keyword">this</span>,</div><div class="line">                  <span class="keyword">this</span>.realApplication, <span class="keyword">this</span>.externalResourcePath);</div><div class="line">          MonkeyPatcher.monkeyPatchExistingResources(<span class="keyword">this</span>,</div><div class="line">                  <span class="keyword">this</span>.externalResourcePath, <span class="keyword">null</span>);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          MonkeyPatcher.monkeyPatchApplication(<span class="keyword">this</span>, <span class="keyword">this</span>,<span class="comment">//åå°„ ActivityThread æ›¿æ¢Application</span></div><div class="line">                  <span class="keyword">this</span>.realApplication, <span class="keyword">null</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (AppInfo.applicationId != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              boolean foundPackage = <span class="keyword">false</span>;</div><div class="line">              <span class="built_in">int</span> pid = Process.myPid();</div><div class="line">              ActivityManager manager = (ActivityManager) getSystemService(<span class="string">"activity"</span>);</div><div class="line">              <span class="built_in">List</span> processes = manager</div><div class="line">                      .getRunningAppProcesses();</div><div class="line">              boolean startServer = <span class="keyword">false</span>;</div><div class="line">              <span class="keyword">if</span> ((processes != <span class="keyword">null</span>) &amp;&amp; (processes.size() &gt; <span class="number">1</span>)) &#123;</div><div class="line">                  <span class="keyword">for</span> (ActivityManager.RunningAppProcessInfo processInfo : processes) &#123;</div><div class="line">                      <span class="keyword">if</span> (AppInfo.applicationId</div><div class="line">                              .equals(processInfo.processName)) &#123;</div><div class="line">                          foundPackage = <span class="keyword">true</span>;</div><div class="line">                          <span class="keyword">if</span> (processInfo.pid == pid) &#123;</div><div class="line">                              startServer = <span class="keyword">true</span>;</div><div class="line">                              <span class="keyword">break</span>;</div><div class="line">                          &#125;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">if</span> ((!startServer) &amp;&amp; (!foundPackage)) &#123;</div><div class="line">                      startServer = <span class="keyword">true</span>;</div><div class="line">                  &#125;</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                  startServer = <span class="keyword">true</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="keyword">if</span> (startServer) &#123;</div><div class="line">                  Server.create(AppInfo.applicationId, <span class="keyword">this</span>);</div><div class="line">              &#125;</div><div class="line">          &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">              Server.create(AppInfo.applicationId, <span class="keyword">this</span>);</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">          <span class="keyword">this</span>.realApplication.onCreate();<span class="comment">//çœŸæ­£çš„applicationå›è°ƒonCreate</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">   public <span class="keyword">static</span> <span class="keyword">void</span> monkeyPatchApplication(Context context,</div><div class="line">                                            Application bootstrap, Application realApplication,</div><div class="line">                                            <span class="built_in">String</span> externalResourceFile) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          Class activityThread = Class</div><div class="line">                  .forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">          <span class="built_in">Object</span> currentActivityThread = getActivityThread(context,</div><div class="line">                  activityThread);</div><div class="line">          Field mInitialApplication = activityThread</div><div class="line">                  .getDeclaredField(<span class="string">"mInitialApplication"</span>);</div><div class="line">          mInitialApplication.setAccessible(<span class="keyword">true</span>);</div><div class="line">          Application initialApplication = (Application) mInitialApplication</div><div class="line">                  .<span class="keyword">get</span>(currentActivityThread);</div><div class="line">          <span class="keyword">if</span> ((realApplication != <span class="keyword">null</span>) &amp;&amp; (initialApplication == bootstrap)) &#123;</div><div class="line">              mInitialApplication.<span class="keyword">set</span>(currentActivityThread, realApplication);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">              Field mAllApplications = activityThread</div><div class="line">                      .getDeclaredField(<span class="string">"mAllApplications"</span>);</div><div class="line">              mAllApplications.setAccessible(<span class="keyword">true</span>);</div><div class="line">              <span class="built_in">List</span> allApplications = (<span class="built_in">List</span>) mAllApplications</div><div class="line">                      .<span class="keyword">get</span>(currentActivityThread);</div><div class="line">              <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; allApplications.size(); i++) &#123;</div><div class="line">                  <span class="keyword">if</span> (allApplications.<span class="keyword">get</span>(i) == bootstrap) &#123;</div><div class="line">                      allApplications.<span class="keyword">set</span>(i, realApplication);<span class="comment">//å®Œæˆapplicationçš„æ›¿æ¢</span></div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">          Class loadedApkClass;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              loadedApkClass = Class.forName(<span class="string">"android.app.LoadedApk"</span>);</div><div class="line">          &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">              loadedApkClass = Class</div><div class="line">                      .forName(<span class="string">"android.app.ActivityThread$PackageInfo"</span>);</div><div class="line">          &#125;</div><div class="line">          Field mApplication = loadedApkClass</div><div class="line">                  .getDeclaredField(<span class="string">"mApplication"</span>);</div><div class="line">          mApplication.setAccessible(<span class="keyword">true</span>);</div><div class="line">          Field mResDir = loadedApkClass.getDeclaredField(<span class="string">"mResDir"</span>);</div><div class="line">          mResDir.setAccessible(<span class="keyword">true</span>);</div><div class="line">          Field mLoadedApk = <span class="keyword">null</span>;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">              mLoadedApk = Application.<span class="keyword">class</span>.getDeclaredField(<span class="string">"mLoadedApk"</span>);</div><div class="line">          &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">for</span> (<span class="built_in">String</span> fieldName : <span class="keyword">new</span> <span class="built_in">String</span>[] &#123; <span class="string">"mPackages"</span>,</div><div class="line">                  <span class="string">"mResourcePackages"</span> &#125;) &#123;</div><div class="line">              Field field = activityThread.getDeclaredField(fieldName);</div><div class="line">              field.setAccessible(<span class="keyword">true</span>);</div><div class="line">              <span class="built_in">Object</span> value = field.<span class="keyword">get</span>(currentActivityThread);</div><div class="line">              <span class="keyword">for</span> (<span class="built_in">Map</span>.Entry&gt; entry : ((<span class="built_in">Map</span>&gt;) value).entrySet()) &#123;</div><div class="line">                  <span class="built_in">Object</span> loadedApk = ((WeakReference) entry.getValue()).<span class="keyword">get</span>();</div><div class="line">                  <span class="keyword">if</span> (loadedApk != <span class="keyword">null</span>) &#123;</div><div class="line">                      <span class="keyword">if</span> (mApplication.<span class="keyword">get</span>(loadedApk) == bootstrap) &#123;</div><div class="line">                          <span class="keyword">if</span> (realApplication != <span class="keyword">null</span>) &#123;</div><div class="line">                              mApplication.<span class="keyword">set</span>(loadedApk, realApplication);</div><div class="line">                          &#125;</div><div class="line">                          <span class="keyword">if</span> (externalResourceFile != <span class="keyword">null</span>) &#123;</div><div class="line">                              mResDir.<span class="keyword">set</span>(loadedApk, externalResourceFile);<span class="comment">//èµ„æºæ–‡ä»¶æ›¿æ¢</span></div><div class="line">                          &#125;</div><div class="line">                          <span class="keyword">if</span> ((realApplication != <span class="keyword">null</span>)</div><div class="line">                                  &amp;&amp; (mLoadedApk != <span class="keyword">null</span>)) &#123;</div><div class="line">                              mLoadedApk.<span class="keyword">set</span>(realApplication, loadedApk);</div><div class="line">                          &#125;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>ç¨‹åºåœ¨è°ƒç”¨realApplicationå‰ï¼Œæ›¿æ¢è°ƒäº†è‡ªå·±è¿›ç¨‹ä¸­æ‰€æœ‰å…³äºApplicationçš„å®ä¾‹ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>ActivityThreadçš„mInitialApplicationä¸ºrealApplication</li>
<li>mAllApplications ä¸­æ‰€æœ‰çš„Applicationä¸ºrealApplication</li>
<li>ActivityThreadçš„mPackages,mResourcePackagesä¸­çš„mLoaderApkä¸­çš„applicationä¸ºrealApplicationã€‚</li>
</ul>
<p><em>monkeyPatchExistingResources</em>æ–¹æ³•ä¸­æ›¿æ¢èµ„æºé—®é¢˜,æ–°å»ºä¸€ä¸ªAssetManagerå¯¹è±¡newAssetManagerï¼Œç„¶åç”¨newAssetManagerå¯¹è±¡æ›¿æ¢æ‰€æœ‰å½“å‰Resourceã€Resource.Themeçš„mAssetsæˆå‘˜å˜é‡ã€‚</p>
<p>åˆ°è¿™é‡ŒAPKå®Œæˆäº†å¯åŠ¨æ“ä½œï¼Œæ¥ä¸‹æ¥é‡ç‚¹åˆ†æä¸‹ç¥å¥‡çš„handleHotSwapPatchçƒ­éƒ¨ç½²ï¼Œä¸ç”¨é‡å¯Activityï¼Œä¸ç”¨é‡å¯è¿›ç¨‹ï¼Œå°±å¯ä»¥å³æ—¶ç”Ÿæ•ˆï¼Œè¿™ç§æ–¹æ¡ˆå¯¹å®‰å“çš„çº¿ä¸Šçƒ­ä¿®å¤æœ‰å¾ˆå¤§çš„æ€è·¯å€Ÿé‰´ã€‚</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> int handleHotSwapPatch(int updateMode, ApplicationPatch patch) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">String</span> dexFile = FileManager.writeTempDexFile(patch.getBytes());</div><div class="line">        <span class="keyword">if</span> (dexFile == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> updateMode;<span class="comment">//code update mode</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">String</span> nativeLibraryPath = FileManager.getNativeLibraryFolder()</div><div class="line">                .getPath();</div><div class="line">        DexClassLoader dexClassLoader = <span class="keyword">new</span> <span class="type">DexClassLoader</span>(dexFile,</div><div class="line">                <span class="built_in">this</span>.mApplication.getCacheDir().getPath(),</div><div class="line">                nativeLibraryPath, getClass().getClassLoader());<span class="comment">//åŠ è½½dex</span></div><div class="line"></div><div class="line">        Class&lt;?&gt; aClass = Class.forName(</div><div class="line">                <span class="string">"com.android.tools.fd.runtime.AppPatchesLoaderImpl"</span>, <span class="literal">true</span>,</div><div class="line">                dexClassLoader);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            PatchesLoader loader = (PatchesLoader) aClass.<span class="keyword">new</span><span class="type">Instance</span>();</div><div class="line">            <span class="keyword">String</span>[] getPatchedClasses = (<span class="keyword">String</span>[]) aClass</div><div class="line">                    .getDeclaredMethod(<span class="string">"getPatchedClasses"</span>, <span class="keyword">new</span> <span class="type">Class</span>[<span class="number">0</span>])</div><div class="line">                    .invoke(loader, <span class="keyword">new</span> <span class="type">Object</span>[<span class="number">0</span>]);</div><div class="line"> </div><div class="line">            <span class="keyword">if</span> (!loader.load()) &#123;</div><div class="line">                updateMode = <span class="number">3</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            Log.e(<span class="string">"InstantRun"</span>, <span class="string">"Couldn't apply code changes"</span>, e);</div><div class="line">            e.printStackTrace();</div><div class="line">            updateMode = <span class="number">3</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">        Log.e(<span class="string">"InstantRun"</span>, <span class="string">"Couldn't apply code changes"</span>, e);</div><div class="line">        updateMode = <span class="number">3</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> updateMode;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>handleHotSwapPatchä¸»è¦ä½œç”¨æ˜¯åå°„è°ƒç”¨AppPatchesLoaderImplç±»çš„loadæ–¹æ³•,çœ‹ä¸‹loadæ–¹æ³•å…·ä½“å®ç°ï¼š</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="built_in">boolean</span> load() &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">String</span> className : getPatchedClasses()) &#123;</div><div class="line">                ClassLoader cl = getClass().getClassLoader();</div><div class="line">                Class&lt;?&gt; aClass = cl.loadClass(className + <span class="string">"$override"</span>);</div><div class="line">                <span class="keyword">Object</span> o = aClass.newInstance();</div><div class="line">                Class&lt;?&gt; originalClass = cl.loadClass(className);</div><div class="line">                Field changeField = originalClass.getDeclaredField(<span class="string">"$change"</span>);</div><div class="line"></div><div class="line">                changeField.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">                <span class="keyword">Object</span> previous = changeField.<span class="built_in">get</span>(<span class="keyword">null</span>);</div><div class="line">                <span class="keyword">if</span> (previous != <span class="keyword">null</span>) &#123;</div><div class="line">                    Field isObsolete = previous.getClass().getDeclaredField(</div><div class="line">                            <span class="string">"$obsolete"</span>);</div><div class="line">                    <span class="keyword">if</span> (isObsolete != <span class="keyword">null</span>) &#123;</div><div class="line">                        isObsolete.<span class="built_in">set</span>(<span class="keyword">null</span>, Boolean.valueOf(<span class="keyword">true</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                changeField.<span class="built_in">set</span>(<span class="keyword">null</span>, o);</div><div class="line">                <span class="keyword">if</span> ((Log.logging != <span class="keyword">null</span>)</div><div class="line">                        &amp;&amp; (Log.logging.isLoggable(Level.FINE))) &#123;</div><div class="line">                    Log.logging.<span class="built_in">log</span>(Level.FINE, <span class="keyword">String</span>.format(<span class="string">"patched %s"</span>,</div><div class="line">                            <span class="keyword">new</span> <span class="keyword">Object</span>[] &#123; className &#125;));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            <span class="keyword">if</span> (Log.logging != <span class="keyword">null</span>) &#123;</div><div class="line">                Log.logging.<span class="built_in">log</span>(Level.SEVERE, <span class="keyword">String</span>.format(</div><div class="line">                        <span class="string">"Exception while patching %s"</span>,</div><div class="line">                        <span class="keyword">new</span> <span class="keyword">Object</span>[] &#123; <span class="string">"foo.bar"</span> &#125;), e);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>loadæ–¹æ³•ä¸»è¦åŠ è½½äº†ä»¥<em>â€œPatchç±»å+$overrideâ€</em>å‘½åçš„ä¸€ä¸ªç±»ï¼Œå¹¶åˆæ¬¡åŠ è½½æ—¶æŠŠè¯¥ç±»<strong>$change</strong>ä¸­æˆå‘˜<em>$obsolete</em>è®¾ç½®æˆ<em>true</em>ï¼Œç„¶åèµ‹å€¼ç»™å·²ç»åŠ è½½çš„åŸå§‹ç±»ã€‚</p>
<p>åç¼–è¯‘åŸclassæ–‡ä»¶ï¼Œä¼šå‘ç°æ¯ä¸ªç±»ä¼šå¤šä¸ª<em>â€œIncrementalChange localIncrementalChange = $changeâ€</em>æˆå‘˜ï¼Œå¹¶ä¼šåœ¨æ¯ä¸ªæ–¹æ³•å†…æ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œå·²æ‹¦æˆªpatchæ‰§è¡Œé€»è¾‘ã€‚</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle paramBundle)</span> </span>&#123;</div><div class="line">     IncrementalChange localIncrementalChange = $change;</div><div class="line">     <span class="keyword">if</span> (localIncrementalChange != <span class="keyword">null</span>) &#123;<span class="comment">//å¦‚ä¸Šæ–‡ä¸­åŠ è½½æ­¥éª¤ï¼Œä¼šç”¨patchç±»ç»™äºˆèµ‹å€¼ï¼Œç„¶åèµ°æ–°ä»£ç é€»è¾‘</span></div><div class="line">         localIncrementalChange.access$dispatch(</div><div class="line">                 <span class="string">"onCreate.(Landroid/os/Bundle;)V"</span>, <span class="keyword">new</span> Object[] &#123; <span class="keyword">this</span>,</div><div class="line">                         paramBundle &#125;);<span class="comment">//é€šè¿‡IncrementalChangeæ¥å£ï¼Œåˆ†æ´¾åˆ°å¯¹åº”çš„æ–°æ–¹æ³•é€»è¾‘</span></div><div class="line">         <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">super</span>.onCreate(paramBundle);</div><div class="line">     ...</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ ·ï¼Œå°±å¯ä»¥ä¸ç”¨é‡å¯ï¼Œå³æ—¶è°ƒç”¨æ–°ç±»ä¸­çš„æ–°æ–¹æ³•é€»è¾‘ã€‚æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¿›ä¸€æ­¥çœ‹ä¸‹<em>nuptboyzhb</em>åŒå­¦åç¼–è¯‘çš„intant run<a href="https://github.com/nuptboyzhb/AndroidInstantRun" target="_blank" rel="external">æºç </a>ã€‚</p>
<h2 id="å››ã€æ¨¡å—åŒ–"><a href="#å››ã€æ¨¡å—åŒ–" class="headerlink" title="å››ã€æ¨¡å—åŒ–"></a>å››ã€æ¨¡å—åŒ–</h2><p>å®‰å“æŠ€æœ¯å‘å±•åˆ°æˆç†Ÿå™¨ï¼Œå®‰å“å®¢æˆ·åº¦é¡¹ç›®å‘å±•åˆ°ä¸€å®šè§„æ¨¡ï¼Œä¸ºäº†ä¾¿äºå„ä¸ªä¸šåŠ¡çº¿ä½è€¦åˆå¼€å‘ã€åŠ å¿«ç¼–è¯‘é€Ÿåº¦ã€æŒ‰æ¨¡å—ä¸šåŠ¡å‡çº§åŠæµ‹è¯•ç­‰æ–¹é¢çš„é«˜æ•ˆè¿›è¡Œï¼Œå„å®¶éƒ½é™†ç»­æå‡ºäº†æ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆã€‚</p>
<p>è®²åˆ°æ¨¡å—åŒ–ï¼Œè¿˜æœ‰ä¸ªæ¦‚å¿µæ˜¯â€œç»„ä»¶åŒ–â€ï¼Œç½‘ä¸Šæœ‰åšå®¢ç›´æ¥è®¤ä¸ºæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä¸ªäººè®¤ä¸ºï¼Œä¸¤è€…è¿˜æ˜¯æœ‰æœ¬è´¨çš„ä¸åŒçš„ã€‚</p>
<p>ä¸ªäººç†è§£ï¼Œç»„ä»¶åŒ–ç›®æ ‡å¯¹è±¡æ˜¯ä»£ç ï¼Œä¸ºäº†è§£è€¦åŠŸèƒ½æ¨¡å—ä»£ç ï¼ŒåŠ å¤§å¤ç”¨åŠ›åº¦ï¼ŒæŒ‰ç…§ä»£ç åŠŸèƒ½æ¨¡å—æŠ½ç¦»å‡ºç»„ä»¶æ¨¡å—ï¼Œå½¢æˆé¡¹ç›®çš„â€œç»„ä»¶åŒ–â€ã€‚è€Œæ¨¡å—åŒ–ç›®æ ‡å¯¹è±¡æ˜¯å¼€å‘äººå‘˜ï¼Œæ›´å¤šçš„æ˜¯ä»¥ä¸šåŠ¡çº¿ä¸ºç•Œé™ï¼Œè§£è€¦ä¸šåŠ¡çº¿é—´çš„ä»£ç è°ƒç”¨ï¼Œä½¿å¾—ä¸€ä¸ªä¸šåŠ¡çº¿å†…é«˜å†…èšï¼Œå¯ä»¥ç‹¬ç«‹å®Œæˆå¼€å‘åˆ°ä¸Šçº¿å„é˜¶æ®µå·¥ä½œï¼Œè€Œä¸å—å…¶ä»–æ¨¡å—å¼€å‘å½±å“ã€‚ä¹Ÿå¯ä»¥è¯´ç»„ä»¶åŒ–åªæ˜¯æ¨¡å—åŒ–é¡¹ç›®ä¸­çš„ä¸€ä¸ªå­é›†æ¦‚å¿µã€‚</p>
<p>æ¨¡å—åŒ–è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è¾¾åˆ°çš„å¼€å‘ç›®æ ‡è¦æ±‚ï¼Œè¿™å¼•ç”¨é˜¿é‡Œ<em>Atlas</em>å¼€æºé¡¹ç›®ç›®æ ‡å®šä¹‰ï¼š</p>
<ul>
<li>åœ¨å·¥ç¨‹æœŸï¼Œå®ç°å·¥ç¨‹ç‹¬ç«‹å¼€å‘ï¼Œè°ƒè¯•çš„åŠŸèƒ½ï¼Œå·¥ç¨‹æ¨¡å—å¯ä»¥ç‹¬ç«‹ã€‚</li>
<li>åœ¨è¿è¡ŒæœŸï¼Œå®ç°å®Œæ•´çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸçš„æ˜ å°„ï¼Œç±»éš”ç¦»ç­‰æœºåˆ¶ã€‚</li>
<li>åœ¨è¿ç»´æœŸï¼Œæä¾›å¿«é€Ÿå¢é‡çš„æ›´æ–°ä¿®å¤èƒ½åŠ›ï¼Œå¿«é€Ÿå‡çº§ã€‚</li>
</ul>
<p>ç„¶è€Œï¼Œåœ¨Javaä¸–ç•Œé‡Œï¼Œå·²ç»æœ‰äº†OSGIè§„èŒƒï¼Œæ˜¯åŸºäºJavaè¯­è¨€çš„åŠ¨æ€æ¨¡å—åŒ–è§„èŒƒã€‚å®‰å“æ¨¡å—ä¸Šï¼Œä¹Ÿå¯ä»¥å‚è€ƒ<em>OSGI</em>çš„è§£è€¦æ–¹å¼ï¼Œå®šåˆ¶ClassLoaderï¼ŒåŠ¨æ€åŠ è½½æ¨¡å—ä»£ç ã€‚</p>
<p>æœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶çš„é˜¿é‡Œçš„æ‰‹æœºæ·˜å®ç ”å‘å›¢é˜Ÿå¼€æºæ€ç»„ä»¶åŒ–(Dynamic Bundle)æ¡†æ¶é¡¹ç›®<a href="http://atlas.taobao.org/" target="_blank" rel="external">Atlas</a>ã€‚</p>
<h2 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦ä»¥å®è§‚è§†è§’ï¼Œä»JavaåŠ¨æ€åŠ è½½åŸºç¡€çŸ¥è¯†ï¼Œåˆ°æœ€è¿‘æ¯”è¾ƒæµè¡Œçš„â€œæ¨¡å—åŒ–â€è¿›è¡Œäº†åŸºæœ¬æ¦‚å¿µåŠæŠ€æœ¯åŸºç¡€çš„å›é¡¾ï¼Œç›®çš„æ˜¯å¯¹ æœ‰å…³JavaåŠ¨æ€åŠ è½½æŠ€æœ¯åœ¨å®‰å“å¹³å°ä¸Šçš„åº”ç”¨ ç­‰ç›¸å…³çš„æŠ€æœ¯æ ‘çš„æ•´ç†å’Œæ¢³ç†ã€‚å¸Œæœ›èƒ½å¤Ÿå¯¹å®‰å“å¹³å°çš„æ’ä»¶åŒ–ã€åŠæ¨¡å—åŒ–ç›¸å…³çš„åŠ¨æ€åŠ è½½æŠ€æœ¯æœ‰ä¸ªæ•´ç†å®è§‚äº†è§£ï¼Œå¹¶é’ˆå¯¹ä¸€å®šæ–¹å‘æœ‰ä¸€å®šæ·±å…¥ç ”ç©¶ã€‚</p>
<hr>
<p>æ¬¢è¿è½¬è½½ï¼Œè¯·æ ‡æ˜å‡ºå¤„ï¼šå¸¸å…´Eç«™ <a href="http://www.canking.win">canking.win</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.canking.win/2018/01/07/dy-load/" data-id="cjfgng5ib000hwo3kaz5nwiyh" class="article-share-link">åˆ†äº«</a><div class="tags"><a href="/tags/java/">java</a></div><div class="post-nav"><a href="/2017/12/09/mvvm/" class="pre">Lifecycle+Retrofit+Roomå®Œç¾ç»“åˆ é¢†ç•¥æ¶æ„ä¹‹ç¾</a><a href="/2018/03/20/mem-oom/" class="next">Javaå†…å­˜é—®é¢˜ åŠ LeakCanary åŸç†åˆ†æ</a></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="æ‰“èµ" class="btn_donate"></a><span class="donate_txt"><br>		   Enjoy it ? Donate me :  å…è´¹åˆ†äº«ï¼Œå…±åŒæˆé•¿</span><br></div><div id="donate_guide" class="donate_bar center hidden"><a id="donate_weixin" href="http://www.canking.win/images/weixin.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/weixin.jpg" fuck="å¾®ä¿¡æ‰“èµ"></a><a id="donate_zhifubao" href="http://www.canking.win/images/zhifubao.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/zhifubao.jpg" fuck="æ”¯ä»˜å®æ‰“èµ"></a></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
$('#donate_board').addClass('hidden');
$('#donate_guide').removeClass('hidden');
}</script></div><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-4889224929687616",
enable_page_level_ads: true
});

</script></script><div id="uyan_frame"></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136494"></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://www.canking.win"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design-patterns/">design patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/Plugin/" style="font-size: 15px;">Plugin</a> <a href="/tags/æºç /" style="font-size: 15px;">æºç </a> <a href="/tags/JobQueue/" style="font-size: 15px;">JobQueue</a> <a href="/tags/smart-update/" style="font-size: 15px;">smart update</a> <a href="/tags/float-permission/" style="font-size: 15px;">float permission</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/theme/" style="font-size: 15px;">theme</a> <a href="/tags/Charles/" style="font-size: 15px;">Charles</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/Material-Design/" style="font-size: 15px;">Material Design</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/source-code/" style="font-size: 15px;">source code</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/30/sharedpref/">ä½ æœ€äº†è§£çš„ SharedPreferenceå’ŒContentProvider çŸ¥å¤šå°‘</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/20/mem-oom/">Javaå†…å­˜é—®é¢˜ åŠ LeakCanary åŸç†åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/07/dy-load/">å®‰å“å¹³å°ä¸­çš„åŠ¨æ€åŠ è½½æŠ€æœ¯åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/mvvm/">Lifecycle+Retrofit+Roomå®Œç¾ç»“åˆ é¢†ç•¥æ¶æ„ä¹‹ç¾</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/gradle-android-res/">Gradleæ’ä»¶å¼€å‘ APKç˜¦èº«èµ„æºè‡ªå®šä¹‰7zå‹ç¼©</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/minipay/">å…sdkå®ç°å¾®ä¿¡ï¼æ”¯ä»˜å®è½¬è´¦æ‰“èµåŠŸèƒ½</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/03/charles-map/">çŸ¥è¯†æ€»ç»“ä¹‹ CharlesæŠ“åŒ…å·¥å…·ä½¿ç”¨æ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/design-ui/">çŸ¥è¯†æ€»ç»“ä¹‹ Material Designåº“å¸¸ç”¨æ§ä»¶æ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/plugin-hook/">çŸ¥è¯†æ€»ç»“ä¹‹ æ’ä»¶åŒ–å­¦ä¹  Hookç³»ç»Ÿæ–¹æ³•åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/plugin-activity-loader/">çŸ¥è¯†æ€»ç»“ä¹‹ æ’ä»¶åŒ– å å‘ç±»Activityå®ç°æ–¹å¼åˆ†æ</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://www.canking.win/fitness" title="å¥ç¾è®¡æ­¥å™¨" target="_blank">å¥ç¾è®¡æ­¥å™¨</a><ul></ul><a href="http://www.canking.win/chargehelper" title="å……ç”µåŠ©æ‰‹" target="_blank">å……ç”µåŠ©æ‰‹</a><ul></ul><a href="http://sudoku.strikingly.com/" title="çˆ±æˆ‘æ•°ç‹¬" target="_blank">çˆ±æˆ‘æ•°ç‹¬</a><ul></ul><a href="http://stopwatch.strikingly.com/" title="ç²¾ç¡®ç§’è¡¨" target="_blank">ç²¾ç¡®ç§’è¡¨</a><ul></ul><a href="http://www.wandoujia.com/apps/net.canking.gameby" title="è‰² å˜" target="_blank">è‰² å˜</a><ul></ul><a href="http://canking.strikingly.com/" title="è‡ªæˆ‘ç®€ä»‹" target="_blank">è‡ªæˆ‘ç®€ä»‹</a><ul></ul><a href="http://cankingapp.github.io/fitness/h5game/index.html" title="H5 Game" target="_blank">H5 Game</a></div><iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&;fansRow=2&amp;ptype=1&amp;speed=0&amp;skin=1&amp;isTitle=1&amp;noborder=0&isWeibo=1&isFans=1&uid=1894127781&verifier=b6b87527&amp;dpc=1"></iframe></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Â© <a href="/." rel="nofollow">å¸¸å…´ E ç«™.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> changxing</a> by<a rel="nofollow" target="_blank" href="https://github.com/CankingApp/"> GitHub.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>