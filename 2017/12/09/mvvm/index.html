<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="做酷的东西, 成为伟大的工程师，写匪夷所思的代码，然后和每个人成为朋友．"><title>Lifecycle+Retrofit+Room完美结合 领略架构之美 | 常兴 E 站</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="Bookmark" href="/favicon.ico"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Lifecycle+Retrofit+Room完美结合 领略架构之美</h1><a id="logo" href="/.">常兴 E 站</a><p class="description">Action Speak Louder Than Words.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/sitemap.xml"><i class="fa fa-rss"> sitemap</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Lifecycle+Retrofit+Room完美结合 领略架构之美</h1><div class="post-meta">Dec 9, 2017<span> | </span><span class="category"><a href="/categories/android/">android</a></span></div><div class="post-content"><p>安卓开发技术发展到现在已经非常成熟，有很多的技术专项如插件，热修，加固，瘦身，性能优化，自动化测试等已经在业界有了完善的或者开源的解决方案。<br>作为一枚多年的安卓研发，有必要学习或了解下这些优秀的解决方案，领略那些行业<em>开创者</em>的思想魅力，然后转化为自己的技术技能，争取应用到日常的开发中去，提高自己研发水平。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1771342-3aeff59b47451ee0.png?imageMogr2/auto-orient/" alt="库引用信息"></p>
<a id="more"></a>
<h1 id="Lifecycle-Retrofit-Room-云端漫步飞一般的感觉"><a href="#Lifecycle-Retrofit-Room-云端漫步飞一般的感觉" class="headerlink" title="Lifecycle+Retrofit+Room 云端漫步飞一般的感觉"></a>Lifecycle+Retrofit+Room 云端漫步飞一般的感觉</h1><p>安卓项目的开发结构，有原来最初的mvc，到后来有人提出的mvp，然后到mvvm的发展，无非就是依着<em>六大设计原则</em>的不断解耦，不断演变，使得项目的开发高度组件化，满足日常复杂多变的项目需求。</p>
<ul>
<li>依赖倒置原则－Dependency Inversion Principle (DIP) </li>
<li>里氏替换原则－Liskov Substitution Principle (LSP) </li>
<li>接口分隔原则－Interface Segregation Principle (ISP) </li>
<li>单一职责原则－Single Responsibility Principle (SRP) </li>
<li>开闭原则－The Open-Closed Principle (OCP)</li>
<li>迪米特法则－Law of Demeter (LOD)</li>
</ul>
<p>目前针对MVVM框架结构，<a href="https://developer.android.google.cn/topic/libraries/architecture/adding-components.html" target="_blank" rel="external">安卓官方</a>也给出了稳定的架构版本1.0。</p>
<p>本文也是围绕者官方思想，试着从<em>源码角度总结</em>学习经验，最后将这些控件二次封装，更加便于理解使用。其也会涉及到其他优秀的的库，如Gson,Glide,BaseRecyclerViewAdapterHelper等</p>
<h2 id="一-起因"><a href="#一-起因" class="headerlink" title="一.起因"></a>一.起因</h2><p>去年还在手机卫士团队做垃圾清理模块时候，赶上模块化二次代码重构技术需求，项目分为多个进程，其中后台进程负责从DB中获取数据（DB可云端更新升级），然后结合云端配置信息做相关逻辑操作，将数据回传到UI进程，UI进程中在后台线程中二次封装，最后post到主UI线程Update到界面展示给用户。</p>
<p>当时就和团队的同学沟通交流，面对这种数据多层次复杂的处理逻辑，设想可以做一种机制，将UI层的更新绑定到一个数据源，数据源数据的更新可以自动触发UI更新，实现与UI的解耦。<br>数据源控制着数据的来源，每种来源有着独立的逻辑分层，共享底层一些公共lib库。</p>
<p>后来想想，其实差不多就是MVVM思想，直到谷歌官方宣布<a href="https://mp.weixin.qq.com/s/9rC_5GhdAA_EMEbWKJT5vQ" target="_blank" rel="external">Android 架构组件 1.0 稳定版</a>的发布，才下决心学习下官方这一套思想，感受优秀的架构。</p>
<p>引用官方一张结构图如下：<br><img src="arch1.png" alt="arch"></p>
<h2 id="二-各组件库原理及基本用法"><a href="#二-各组件库原理及基本用法" class="headerlink" title="二.各组件库原理及基本用法"></a>二.各组件库原理及基本用法</h2><p>这里主要探究下主要组件库的基本用法和原理，以理解其优秀思想为主。</p>
<h3 id="谷歌官方Android-Architecture-Components"><a href="#谷歌官方Android-Architecture-Components" class="headerlink" title="谷歌官方Android Architecture Components"></a>谷歌官方Android Architecture Components</h3><p><strong>Lifecycle+LiveData+ViewMode+Room</strong> </p>
<blockquote>
<p>A collection of libraries that help you design robust, testable, and maintainable apps. Start with classes for managing your UI component lifecycle and handling data persistence.</p>
</blockquote>
<h4 id="Lifecyle"><a href="#Lifecyle" class="headerlink" title="Lifecyle"></a>Lifecyle</h4><p>一个安卓组件生命周期感知回调的控件，可以感知activity或fragment的生命周期变化，并回调相应接口。</p>
<p>可以先从源码抽象类分析，如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> &#123;</span></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> addObserver(<span class="meta">@NonNull</span> LifecycleObserver observer);</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> removeObserver(<span class="meta">@NonNull</span> LifecycleObserver observer);</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> State getCurrentState();</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Event</span> &#123;</span></div><div class="line"></div><div class="line">        ON_CREATE,</div><div class="line"> </div><div class="line">        ON_START,</div><div class="line"></div><div class="line">        ON_RESUME,</div><div class="line"></div><div class="line">        ON_PAUSE,</div><div class="line"></div><div class="line">        ON_STOP,</div><div class="line"></div><div class="line">        ON_DESTROY,</div><div class="line"></div><div class="line">        ON_ANY</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">State</span> &#123;</span></div><div class="line"></div><div class="line">        DESTROYED,</div><div class="line">        INITIALIZED,</div><div class="line">        CREATED,</div><div class="line">        STARTED,</div><div class="line">        RESUMED;</div><div class="line"></div><div class="line">        <span class="keyword">public</span> <span class="keyword">boolean</span> isAtLeast(<span class="meta">@NonNull</span> State state) &#123;</div><div class="line">            <span class="keyword">return</span> compareTo(state) &gt;= <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Marks a class as a LifecycleObserver. It does not have any methods, instead, relies on</div><div class="line"> * &#123;<span class="doctag">@link</span> OnLifecycleEvent&#125; annotated methods.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * <span class="doctag">@see</span> Lifecycle Lifecycle - for samples and usage patterns.</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleObserver</span> &#123;</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>Lifecycle</em>抽象类有三个方法，可以添加、删除观察者,并且可以获取当前组件的生命周期的状态。<br>而<em>LifecycleObserver</em>接口只是个空接口做类型校验，具体事件交给了OnLifecycleEvent，通过注入回调相应事件。</p>
<p>二在最新的support V4包中，<em>Activity</em>和<em>Fragment</em>都实现了<em>LifecycleOwner</em>接口，意味着我们可以直接使用getLifecyle()获取当前<em>Activity</em>或<em>Fragment</em>的Lifecycle对象，很方便的添加我们的监听方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"WeakerAccess"</span>, <span class="string">"unused"</span>&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleOwner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="function">Lifecycle <span class="title">getLifecycle</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="LiveData"><a href="#LiveData" class="headerlink" title="LiveData"></a>LiveData</h4><p>LiveData是一个持有范型类型的数据组件，将App生命组件与数据关联到一起，可以感知生命变更，规则回调数据变化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveData</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">....        <span class="keyword">private</span> <span class="keyword">volatile</span> Object mData = NOT_SET;<span class="comment">//数据容器类</span></div><div class="line"></div><div class="line">    <span class="comment">//一个写死的处于Resume状态的LifecycleOwner，用于数据回调无限制情况</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LifecycleOwner ALWAYS_ON = <span class="keyword">new</span> LifecycleOwner() &#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> LifecycleRegistry mRegistry = init();</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> LifecycleRegistry <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">            LifecycleRegistry registry = <span class="keyword">new</span> LifecycleRegistry(<span class="keyword">this</span>);</div><div class="line">            registry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);</div><div class="line">            registry.handleLifecycleEvent(Lifecycle.Event.ON_START);</div><div class="line">            registry.handleLifecycleEvent(Lifecycle.Event.ON_RESUME);</div><div class="line">            <span class="keyword">return</span> registry;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mRegistry;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">private</span> SafeIterableMap&lt;Observer&lt;T&gt;, LifecycleBoundObserver&gt; mObservers =</div><div class="line">            <span class="keyword">new</span> SafeIterableMap&lt;&gt;();</div><div class="line">   </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">considerNotify</span><span class="params">(LifecycleBoundObserver observer)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!observer.active) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!isActiveState(observer.owner.getLifecycle().getCurrentState())) &#123;</div><div class="line">            observer.activeStateChanged(<span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (observer.lastVersion &gt;= mVersion) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        observer.lastVersion = mVersion;</div><div class="line">        <span class="comment">//noinspection unchecked</span></div><div class="line">        observer.observer.onChanged((T) mData);<span class="comment">//最终的回调方法地方</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dispatchingValue</span><span class="params">(@Nullable LifecycleBoundObserver initiator)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mDispatchingValue) &#123;</div><div class="line">            mDispatchInvalidated = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        mDispatchingValue = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            mDispatchInvalidated = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (initiator != <span class="keyword">null</span>) &#123;</div><div class="line">                considerNotify(initiator);</div><div class="line">                initiator = <span class="keyword">null</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;Observer&lt;T&gt;, LifecycleBoundObserver&gt;&gt; iterator =</div><div class="line">                        mObservers.iteratorWithAdditions(); iterator.hasNext(); ) &#123;</div><div class="line">                    considerNotify(iterator.next().getValue());<span class="comment">//可以添加做个监听者，这里遍历分发数据到每个监听者</span></div><div class="line">                    <span class="keyword">if</span> (mDispatchInvalidated) &#123;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">while</span> (mDispatchInvalidated);</div><div class="line">        mDispatchingValue = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</div><div class="line">            <span class="comment">// ignore</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</div><div class="line">        LifecycleBoundObserver existing = mObservers.putIfAbsent(observer, wrapper);</div><div class="line">        <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; existing.owner != wrapper.owner) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add the same observer"</span></div><div class="line">                    + <span class="string">" with different lifecycles"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        owner.getLifecycle().addObserver(wrapper);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observeForever</span><span class="params">(@NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</div><div class="line">        observe(ALWAYS_ON, observer);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(@NonNull <span class="keyword">final</span> Observer&lt;T&gt; observer)</span> </span>&#123;</div><div class="line">        assertMainThread(<span class="string">"removeObserver"</span>);</div><div class="line">        LifecycleBoundObserver removed = mObservers.remove(observer);</div><div class="line">        <span class="keyword">if</span> (removed == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        removed.owner.getLifecycle().removeObserver(removed);</div><div class="line">        removed.activeStateChanged(<span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//实现类回调方法</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActive</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//实现类回调方法</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInactive</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LifecycleBoundObserver</span> <span class="keyword">implements</span> <span class="title">GenericLifecycleObserver</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStateChanged</span><span class="params">(LifecycleOwner source, Lifecycle.Event event)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</div><div class="line">                removeObserver(observer);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// immediately set active state, so we'd never dispatch anything to inactive</span></div><div class="line">            <span class="comment">// owner</span></div><div class="line">            activeStateChanged(isActiveState(owner.getLifecycle().getCurrentState()));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">activeStateChanged</span><span class="params">(<span class="keyword">boolean</span> newActive)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (newActive == active) &#123;</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            active = newActive;</div><div class="line">            <span class="keyword">boolean</span> wasInactive = LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span>;</div><div class="line">            LiveData.<span class="keyword">this</span>.mActiveCount += active ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (wasInactive &amp;&amp; active) &#123;</div><div class="line">                onActive();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (LiveData.<span class="keyword">this</span>.mActiveCount == <span class="number">0</span> &amp;&amp; !active) &#123;</div><div class="line">                onInactive();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (active) &#123;<span class="comment">//只有生命组件处于前台时，才触发数据的变更通知</span></div><div class="line">                dispatchingValue(<span class="keyword">this</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isActiveState</span><span class="params">(State state)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> state.isAtLeast(STARTED);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看源码，会发现LiveData有个重要的方法<strong>observe(LifecycleOwner owner, Observer<t> observer)</t></strong>, 在数据源数据有变更时，遍历分发数据到所有监听者，最后会回调onChanged()方法。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span>&lt;<span class="title">T</span>&gt; &#123;</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Called when the data is changed.</div><div class="line">     * <span class="doctag">@param</span> t  The new data</div><div class="line">     */</div><div class="line">    <span class="keyword">void</span> onChanged(<span class="meta">@Nullable</span> T t);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LiveData有两个实现类：<em>MediatorLiveData</em>和<em>MediatorLiveData</em>，继承关系如下：</p>
<p><img src="arch2.png" alt="LiveData"></p>
<p><em>MutableLiveData</em>类只是暴露了两个方法：postData()和setData()。<br><em>MediatorLiveData</em>类有个<strong>addSource()</strong>方法，可以实现监听另一个或多个LiveData数据源变化，这样我们就可以比较便捷且低耦合的实现多个数据源的逻辑，并且关联到一个MediatorLiveData上，实现多数据源的自动整合。</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">@MainThread</div><div class="line"><span class="keyword">public</span> &lt;S&gt; <span class="keyword">void</span> addSource(@NonNull LiveData&lt;S&gt; <span class="keyword">source</span>, @NonNull Observer&lt;S&gt; onChanged) &#123;</div><div class="line">    <span class="keyword">Source</span>&lt;S&gt; e = <span class="keyword">new</span> <span class="keyword">Source</span>&lt;&gt;(<span class="keyword">source</span>, onChanged);</div><div class="line">    <span class="keyword">Source</span>&lt;?&gt; existing = mSources.putIfAbsent(<span class="keyword">source</span>, e);</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; existing.mObserver != onChanged) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</div><div class="line">                <span class="string">"This source was already added with the different observer"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (hasActiveObservers()) &#123;</div><div class="line">        e.plug();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ViewModel"><a href="#ViewModel" class="headerlink" title="ViewModel"></a>ViewModel</h4><p>LiveData和LiveCycle将数据与数据，数据与UI生命绑定到了一起，实现了数据的自动管理和更新，那这些数据如何缓存呢？能否在多个页面共享这些数据呢？答案是ViewMode。</p>
<blockquote>
<p>A ViewModel is always created in association with a scope (an fragment or an activity) and will be retained as long as the scope is alive. E.g. if it is an Activity, until it is finished.</p>
</blockquote>
<p>ViewMode相当于一层数据隔离层，将UI层的数据逻辑全部抽离干净，管理制底层数据的获取方式和逻辑。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ViewModel   viewModel = ViewModelProviders.of(<span class="keyword">this</span>).<span class="keyword">get</span>(xxxModel.<span class="keyword">class</span>);</div><div class="line"></div><div class="line">ViewModel   viewModel = ViewModelProviders.of(<span class="keyword">this</span>, factory).<span class="keyword">get</span>(xxxModel.<span class="keyword">class</span>);</div></pre></td></tr></table></figure>
<p>可以通过以上方式获取ViewModel实例，如果有自定义ViewModel构造器参数，需要借助<strong>ViewModelProvider.NewInstanceFactory</strong>，自己实现create方法。</p>
<p>那么，ViewMode是怎么被保存的呢？ 可以顺着ViewModelProviders源码进去看看。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@NonNull</span></div><div class="line"><span class="meta">@MainThread</span></div><div class="line"><span class="keyword">public</span> &lt;T extends ViewModel&gt; T <span class="keyword">get</span>(<span class="meta">@NonNull</span> String key, <span class="meta">@NonNull</span> Class&lt;T&gt; modelClass) &#123;</div><div class="line">    ViewModel viewModel = mViewModelStore.<span class="keyword">get</span>(key);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (modelClass.isInstance(viewModel)) &#123;</div><div class="line">        <span class="comment">//noinspection unchecked</span></div><div class="line">        <span class="keyword">return</span> (T) viewModel;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//noinspection StatementWithEmptyBody</span></div><div class="line">        <span class="keyword">if</span> (viewModel != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="comment">// <span class="doctag">TODO:</span> log a warning.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    viewModel = mFactory.create(modelClass);</div><div class="line">    mViewModelStore.put(key, viewModel);</div><div class="line">    <span class="comment">//noinspection unchecked</span></div><div class="line">    <span class="keyword">return</span> (T) viewModel;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发现get方法会先从缓存中获取，没有的化就会通过<em>Factory</em>的create方法构造一个ViewModel，然后放入缓存，下次直接使用。</p>
<h4 id="Room"><a href="#Room" class="headerlink" title="Room"></a>Room</h4><p>Room是一种ORM（对象关系映射）模式数据库框架，对安卓SQlite的抽象封装，从此操作数据库提供了超便捷方式。</p>
<blockquote>
<p>The Room persistence library provides an abstraction layer over SQLite to allow fluent database access while harnessing the full power of SQLite.</p>
</blockquote>
<p>同样基于ORM模式封装的数据库，比较有名还有<em>GreenDao</em>。而Room和其他ORM对比，具有编译时验证查询语句正常性，支持LiveData数据返回等优势。<br>我们选择room，更多是因为对LiveData的完美支持，可以动态的将DB数据变化自动更新到LiveData上，在通过LiveData自动刷新到UI上。</p>
<p>这里引用网络上的一张Room与其他同类性能对比图片：</p>
<p><img src="arch3.png" alt="性能对比"></p>
<p><em>Room用法：</em></p>
<ul>
<li><ol>
<li>继承RoomDatabase的抽象类, 暴露抽象方法getxxxDao()。</li>
</ol>
</li>
</ul>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Database</span>(entities = &#123;<span class="type">EssayDayEntity</span>.<span class="keyword">class</span>, <span class="type">ZhihuItemEntity</span>.<span class="keyword">class</span>&#125;, version = <span class="number">1</span>)</div><div class="line"><span class="meta">@TypeConverters</span>(<span class="type">DateConverter</span>.<span class="keyword">class</span>)</div><div class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AppDB</span> <span class="keyword">extends</span> <span class="title">RoomDatabase</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> static <span class="type">AppDB</span> sInstance;</div><div class="line"></div><div class="line">    <span class="meta">@VisibleForTesting</span></div><div class="line">    public static <span class="keyword">final</span> <span class="type">String</span> <span class="type">DATABASE_NAME</span> = <span class="string">"canking.db"</span>;</div><div class="line">    public <span class="keyword">abstract</span> <span class="type">EssayDao</span> essayDao();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>获取db实例</li>
</ol>
</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">ppDatabase db</span> = Room.databaseBuilder(getApplicationContext(),</div><div class="line">        AppDatabase.class, <span class="string">"database-name"</span>).build();</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>实现Dao层逻辑</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Dao</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ZhuhuDao</span> </span>&#123;</div><div class="line">    <span class="meta">@Query</span>(<span class="string">"SELECT * FROM zhuhulist  order by id desc, id limit 0,1"</span>)</div><div class="line">    <span class="function">LiveData&lt;ZhihuItemEntity&gt; <span class="title">loadZhuhu</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Insert</span>(onConflict = OnConflictStrategy.REPLACE)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertItem</span><span class="params">(ZhihuItemEntity products)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><ol>
<li>添加一张表结构</li>
</ol>
</li>
</ul>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> &#123;</span></div><div class="line">    <span class="meta">@PrimaryKey</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> uid;</div><div class="line"></div><div class="line">    <span class="meta">@ColumnInfo</span>(name = <span class="string">"first_name"</span>)</div><div class="line">    <span class="keyword">private</span> String firstName;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> String date;<span class="comment">//默认columnInfo 为 date</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>就这么简单，就可以实现数据库的操作，完全隔离的底层复杂的数据库操作，大大节省项目研发重复劳动力。</p>
<p>从使用说明分析，UserDao和Db一个是接口，一个是抽象类，这些逻辑的实现完全是由annotationProcessor依赖注入帮我们实现的, annotationProcessor其实就是开源的android-apt的官方替代品。<br>那么编译项目后，可以在build目录下看到生成相应的类xxx_impl.class。<br><img src="arch4.png" alt="impl"></p>
<p>既然Room支持LiveData数据，那么有可以分析下源码,了解下具体原理，方便以后填坑。</p>
<p>先选Demo中Dao层的insert方法，看看数据如何加载到内存的。我们的query方法如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Insert</span>(onConflict = OnConflictStrategy.REPLACE)</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertItem</span><span class="params">(ZhihuItemEntity products)</span></span>;</div></pre></td></tr></table></figure>
<p>annotationProcessor帮我吗生成后的实现主要代码如下：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final RoomDatabase __db;</div><div class="line"><span class="keyword">private</span> final EntityInsertionAdapter __insertionAdapterOfZhihuItemEntity;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ZhuhuDao_Impl</span>(<span class="params">RoomDatabase __db</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.__db = __db;</div><div class="line">    <span class="comment">//EntityInsertionAdapter类的匿名内部类实现方式，</span></div><div class="line">    <span class="keyword">this</span>.__insertionAdapterOfZhihuItemEntity = <span class="keyword">new</span> EntityInsertionAdapter&lt;ZhihuItemEntity&gt;(__db) &#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">createQuery</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="string">"INSERT OR REPLACE INTO `zhuhulist`(`id`,`date`,`stories`,`top_stories`) VALUES (nullif(?, 0),?,?,?)"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span>(<span class="params">SupportSQLiteStatement stmt, ZhihuItemEntity <span class="keyword">value</span></span>) </span>&#123;</div><div class="line">        	<span class="comment">//通过SQLiteStatement的bind方法，可以很巧妙的将类对象数据转化为数据库要操作的数据类型。</span></div><div class="line">            stmt.bindLong(<span class="number">1</span>, (<span class="keyword">long</span>)<span class="keyword">value</span>.getId());<span class="comment">//按顺序依次放入SQLiteStatement对象。</span></div><div class="line">            <span class="keyword">if</span>(<span class="keyword">value</span>.date == <span class="literal">null</span>) &#123;</div><div class="line">                stmt.bindNull(<span class="number">2</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                stmt.bindString(<span class="number">2</span>, <span class="keyword">value</span>.date);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//通过DB类注入的自定义转化器，我们可以将任何对象类型持久化到数据库中，并且很便捷的从数据库反序列化出来</span></div><div class="line">            String _tmp = DateConverter.toZhihuStoriesEntity(<span class="keyword">value</span>.stories);</div><div class="line">            <span class="keyword">if</span>(_tmp == <span class="literal">null</span>) &#123;</div><div class="line">                stmt.bindNull(<span class="number">3</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                stmt.bindString(<span class="number">3</span>, _tmp);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String _tmp_1 = DateConverter.toZhihuStoriesEntity(<span class="keyword">value</span>.top_stories);</div><div class="line">            <span class="keyword">if</span>(_tmp_1 == <span class="literal">null</span>) &#123;</div><div class="line">                stmt.bindNull(<span class="number">4</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                stmt.bindString(<span class="number">4</span>, _tmp_1);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertItem</span>(<span class="params">ZhihuItemEntity products</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.__db.beginTransaction();</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    	<span class="comment">//借助SQLiteStatement类操作数据库，既优化了数据库操作性能，又巧妙的bind了对象类型数据。</span></div><div class="line">        <span class="keyword">this</span>.__insertionAdapterOfZhihuItemEntity.insert(products);</div><div class="line">        <span class="keyword">this</span>.__db.setTransactionSuccessful();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    	<span class="comment">//这里很重要，我们平时操作数据库或流必须要做 finally块 关闭资源。</span></div><div class="line">        <span class="keyword">this</span>.__db.endTransaction();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现类中可以看出insert是通过<strong>EntityInsertionAdapter</strong>类完成操作的，而EntityInsertionAdapter内部会持有个SupportSQLiteStatement，其实就是<em>SQLiteStatement</em>类的抽象封装。<br>其实例获取是通过RoomData内部方法compileStatement()得到的。</p>
<p>研究下RoomData抽象类源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">RoomDatabase</span> </span>&#123;</div><div class="line">    <span class="comment">// set by the generated open helper.</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> SupportSQLiteDatabase mDatabase;<span class="comment">//SQLiteDatabase类的封装抽象层</span></div><div class="line">    <span class="keyword">private</span> SupportSQLiteOpenHelper mOpenHelper;<span class="comment">//SQLiteOpenHelper类的封装抽象层</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InvalidationTracker mInvalidationTracker;<span class="comment">//绑定数据变更监听器，如在数据变化时通知LiveData</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> SupportSQLiteOpenHelper <span class="title">createOpenHelper</span><span class="params">(DatabaseConfiguration config)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> InvalidationTracker <span class="title">createInvalidationTracker</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(String query, @Nullable Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mOpenHelper.getWritableDatabase().query(<span class="keyword">new</span> SimpleSQLiteQuery(query, args));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(SupportSQLiteQuery query)</span> </span>&#123;</div><div class="line">        assertNotMainThread();<span class="comment">//每次数据库操作检查线程</span></div><div class="line">        <span class="keyword">return</span> mOpenHelper.getWritableDatabase().query(query);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> SupportSQLiteStatement <span class="title">compileStatement</span><span class="params">(String sql)</span> </span>&#123;</div><div class="line">        assertNotMainThread();</div><div class="line">        <span class="keyword">return</span> mOpenHelper.getWritableDatabase().compileStatement(sql);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beginTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">        assertNotMainThread();</div><div class="line">        mInvalidationTracker.syncTriggers();</div><div class="line">        mOpenHelper.getWritableDatabase().beginTransaction();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endTransaction</span><span class="params">()</span> </span>&#123;</div><div class="line">        mOpenHelper.getWritableDatabase().endTransaction();</div><div class="line">        <span class="keyword">if</span> (!inTransaction()) &#123;</div><div class="line">            <span class="comment">// enqueue refresh only if we are NOT in a transaction. Otherwise, wait for the last</span></div><div class="line">            <span class="comment">// endTransaction call to do it.</span></div><div class="line">            mInvalidationTracker.refreshVersionsAsync();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">RoomDatabase</span>&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> MigrationContainer mMigrationContainer;<span class="comment">//数据库升级辅助类</span></div><div class="line"></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Builder&lt;T&gt; <span class="title">addCallback</span><span class="params">(@NonNull Callback callback)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (mCallbacks == <span class="keyword">null</span>) &#123;</div><div class="line">                mCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            &#125;</div><div class="line">            mCallbacks.add(callback);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="comment">//noinspection ConstantConditions</span></div><div class="line">            <span class="keyword">if</span> (mContext == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot provide null context for the database."</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//noinspection ConstantConditions</span></div><div class="line">            <span class="keyword">if</span> (mDatabaseClass == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Must provide an abstract class that"</span></div><div class="line">                        + <span class="string">" extends RoomDatabase"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mFactory == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//默认的SupportSQLiteOpenHelper创建工厂</span></div><div class="line">                mFactory = <span class="keyword">new</span> FrameworkSQLiteOpenHelperFactory();<span class="comment">//SupportSQLiteOpenHelper的实现类，通过mDelegate带来类操作真正的SQLiteOpenHelper</span></div><div class="line">            &#125;</div><div class="line">            DatabaseConfiguration configuration =</div><div class="line">                    <span class="keyword">new</span> DatabaseConfiguration(mContext, mName, mFactory, mMigrationContainer,</div><div class="line">                            mCallbacks, mAllowMainThreadQueries, mRequireMigration);</div><div class="line">            <span class="comment">//最终通过反射加载系统帮我们实现的真正RoomData</span></div><div class="line">            T db = Room.getGeneratedImplementation(mDatabaseClass, DB_IMPL_SUFFIX);</div><div class="line">            db.init(configuration);</div><div class="line">            <span class="keyword">return</span> db;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@NonNull SupportSQLiteDatabase db)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(@NonNull SupportSQLiteDatabase db)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>DB是通过Build设计模式获取实例的，在build过程中，可以添加CallBack抽象类回调数据的<em>onCreate</em>和<em>onOpen</em>。<br>这里发现个问题，抽象层封装那么深，<em>onUpgrade()</em>方法怎么回调呢？数据库的升级怎么添加自己的逻辑呢？奥秘在<strong>MigrationContainer</strong>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MigrationContainer</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> SparseArrayCompat&lt;SparseArrayCompat&lt;Migration&gt;&gt; mMigrations =</div><div class="line">                <span class="keyword">new</span> SparseArrayCompat&lt;&gt;();</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMigrations</span><span class="params">(Migration... migrations)</span> </span>&#123;</div><div class="line">            <span class="keyword">for</span> (Migration migration : migrations) &#123;</div><div class="line">                addMigration(migration);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMigration</span><span class="params">(Migration migration)</span> </span>&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> start = migration.startVersion;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> end = migration.endVersion;</div><div class="line">            SparseArrayCompat&lt;Migration&gt; targetMap = mMigrations.get(start);</div><div class="line">            <span class="keyword">if</span> (targetMap == <span class="keyword">null</span>) &#123;</div><div class="line">                targetMap = <span class="keyword">new</span> SparseArrayCompat&lt;&gt;();</div><div class="line">                mMigrations.put(start, targetMap);</div><div class="line">            &#125;</div><div class="line">            Migration existing = targetMap.get(end);</div><div class="line">            <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</div><div class="line">                Log.w(Room.LOG_TAG, <span class="string">"Overriding migration "</span> + existing + <span class="string">" with "</span> + migration);</div><div class="line">            &#125;</div><div class="line">            targetMap.append(end, migration);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"WeakerAccess"</span>)</div><div class="line">        <span class="meta">@Nullable</span></div><div class="line">        <span class="function"><span class="keyword">public</span> List&lt;Migration&gt; <span class="title">findMigrationPath</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (start == end) &#123;</div><div class="line">                <span class="keyword">return</span> Collections.emptyList();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">boolean</span> migrateUp = end &gt; start;</div><div class="line">            List&lt;Migration&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            <span class="keyword">return</span> findUpMigrationPath(result, migrateUp, start, end);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Migration</span> </span>&#123;</div><div class="line">    	<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> startVersion;</div><div class="line">........<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> endVersion;</div><div class="line"></div><div class="line">    	<span class="function"><span class="keyword">public</span> <span class="title">Migration</span><span class="params">(<span class="keyword">int</span> startVersion, <span class="keyword">int</span> endVersion)</span> </span>&#123;</div><div class="line">       	 <span class="keyword">this</span>.startVersion = startVersion;</div><div class="line">       	 <span class="keyword">this</span>.endVersion = endVersion;</div><div class="line">    	&#125;</div><div class="line"></div><div class="line">    	<span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">migrate</span><span class="params">(@NonNull SupportSQLiteDatabase database)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Room.databaseBuilder过程中，可以通过<em>addMigration()</em>方法，设置多个或一个Migration。</p>
<p>在RoomOpenHelper的onUpgrade()方法中会依次调用升级范围内的Migration:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SupportSQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</div><div class="line">       <span class="keyword">boolean</span> migrated = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">if</span> (mConfiguration != <span class="keyword">null</span>) &#123;</div><div class="line">           List&lt;Migration&gt; migrations = mConfiguration.migrationContainer.findMigrationPath(</div><div class="line">                   oldVersion, newVersion);</div><div class="line">           <span class="keyword">if</span> (migrations != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">for</span> (Migration migration : migrations) &#123;</div><div class="line">                   migration.migrate(db);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>分析Room到这里基本原理已了解，并且我们可以封装自己的Callback接口，对业务模块依次分发onCreate、onUpgrade方法，统一管理数据库的创建和升级。</p>
<h3 id="Retrofit"><a href="#Retrofit" class="headerlink" title="Retrofit"></a>Retrofit</h3><p>当前业界很流行，且很优秀的开源网络库，基于OkHttp之前开发。</p>
<blockquote>
<p>A type-safe HTTP client for Android and Java</p>
</blockquote>
<p>个人理解Retrofit是高度抽象，且和业务耦合度很低的网络库，通过各种数据转化器或适配器，使得网络返回数据可以很奇妙的直接转化为我们想要的类型，与本地数据的缓存及持久化高度无缝对接，大大减少了开发投入。并且使得项目研发更易模块化和迭代升级。</p>
<p>基本用法可以移步<a href="http://square.github.io/retrofit/" target="_blank" rel="external">官网</a>学习研究，这里只分析下如何构造自定义返回类型，默认通用的请求返回如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">XXXService service = retrofit.create(XXXService.<span class="keyword">class</span>);</div><div class="line">Call&lt;List&lt;Repo<span class="meta">&gt;&gt; </span>repos = service.listRepos(<span class="string">"xxx"</span>);</div></pre></td></tr></table></figure>
<figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; T create(<span class="keyword">final</span> <span class="class"><span class="keyword">Class</span>&lt;<span class="title">T</span>&gt; <span class="title">service</span>) &#123;</span></div><div class="line">   Utils.validateServiceInterface(service);</div><div class="line">   <span class="keyword">if</span> (validateEagerly) &#123;</div><div class="line">     eagerlyValidateMethods(service);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> <span class="class"><span class="keyword">Class</span>&lt;?&gt;[] &#123; <span class="title">service</span> &#125;,</span></div><div class="line">       <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">         <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">         @Override <span class="keyword">public</span> Object invoke(Object proxy, <span class="function"><span class="keyword">Method</span> <span class="title">method</span>, @<span class="title">Nullable</span> <span class="title">Object</span>[] <span class="title">args</span>)</span></div><div class="line">             throws Throwable &#123;</div><div class="line">           <span class="keyword">if</span> (<span class="function"><span class="keyword">method</span>.<span class="title">getDeclaringClass</span>(</span>) == Object.class) &#123;</div><div class="line">             <span class="keyword">return</span> <span class="function"><span class="keyword">method</span>.<span class="title">invoke</span>(</span>this, args);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">if</span> (platform.isDefaultMethod(<span class="function"><span class="keyword">method</span>)) &#123;</span></div><div class="line">             <span class="keyword">return</span> platform.invokeDefaultMethod(<span class="function"><span class="keyword">method</span>, <span class="title">service</span>, <span class="title">proxy</span>, <span class="title">args</span>);</span></div><div class="line">           &#125;</div><div class="line">           ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">               (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(<span class="function"><span class="keyword">method</span>);</span></div><div class="line">           OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">           <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">         &#125;</div><div class="line">       &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>retrofit.create方法内部通过java动态代理，链接接口方法，替换转化范型类型及返回类型。<br>Retrofit.Builder有两个重要方法，影响着<em>service.listRepos()</em>方法的返回值类型及反序类型。它们分别是：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Add converter factory for serialization and deserialization of objects. */</span></div><div class="line"><span class="comment">//影响者Call接口中的范型类型</span></div><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">addConverterFactory</span>(<span class="params">Converter.Factory factory</span>) </span>&#123;</div><div class="line">  converterFactories.<span class="keyword">add</span>(checkNotNull(factory, <span class="string">"factory == null"</span>));</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Add a call adapter factory for supporting service method return types other than &#123;@link</div><div class="line"> * Call&#125;.</div><div class="line"> * 影响者Call接口的具体实现类型</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Builder <span class="title">addCallAdapterFactory</span>(<span class="params">CallAdapter.Factory factory</span>) </span>&#123;</div><div class="line">  adapterFactories.<span class="keyword">add</span>(checkNotNull(factory, <span class="string">"factory == null"</span>));</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过addConverterFactory方法，可以将网络返回数据直接转化为本地的具体实体类型，并且retrofit已经为我们提供了常见协议数据类型的封装库，如下：</p>
<table>
<thead>
<tr>
<th>Converter</th>
<th>依赖</th>
</tr>
</thead>
<tbody>
<tr>
<td> Gson</td>
<td>com.squareup.retrofit2:converter-gson:xxx</td>
</tr>
<tr>
<td> Jackson</td>
<td>com.squareup.retrofit2:converter-jackson:xxx</td>
</tr>
<tr>
<td> Moshi</td>
<td>com.squareup.retrofit2:converter-moshi:xxx</td>
</tr>
<tr>
<td> Protobuf</td>
<td>com.squareup.retrofit2:converter-protobuf:xxx</td>
</tr>
<tr>
<td> Wire</td>
<td>com.squareup.retrofit2:converter-wire:xxx</td>
</tr>
<tr>
<td> Simple XML</td>
<td>com.squareup.retrofit2:converter-simplexml:xxx</td>
</tr>
<tr>
<td> Scalars</td>
<td>com.squareup.retrofit2:converter-scalars:xxx</td>
</tr>
</tbody>
</table>
<p>Builder每添加一个转化器会保存在<em>List<converter.factory></converter.factory></em>类型列表中去。通过以下代码转化为目标类型。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = start, count = converterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">    Converter.Factory <span class="keyword">factory</span> = converterFactories.<span class="keyword">get</span>(i);</div><div class="line">    Converter&lt;?, RequestBody&gt; converter =</div><div class="line">        <span class="keyword">factory</span>.requestBodyConverter(type, parameterAnnotations, methodAnnotations, <span class="keyword">this</span>);</div><div class="line">    <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//noinspection unchecked</span></div><div class="line">      <span class="keyword">return</span> (Converter&lt;T, RequestBody&gt;) converter;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>当然也可以自定义Converter类型：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> Converter&lt;F, T&gt; &#123;</div><div class="line">  T convert(F value) throws IOException;</div><div class="line"></div><div class="line">  <span class="keyword">abstract</span> <span class="keyword">class</span> Factory &#123;</div><div class="line">    <span class="comment">// 这里创建从ResponseBody其它类型的Converter，如果不能处理返回null</span></div><div class="line">    <span class="comment">// 主要用于对响应体的处理</span></div><div class="line">    <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type <span class="class"><span class="keyword">type</span>, <span class="title">Annotation</span>[] <span class="title">annotations</span>,</span></div><div class="line">    Retrofit retrofit) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 在这里创建 从自定类型到ResponseBody 的Converter,不能处理就返回null，</span></div><div class="line">    <span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type <span class="class"><span class="keyword">type</span>,</span></div><div class="line">    Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</div><div class="line">    <span class="comment">//在这里实现具体转化逻辑</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Retrfofit对于上面的几个注解默认使用的是调用toString方法</span></div><div class="line">    <span class="keyword">public</span> Converter&lt;?, String&gt; stringConverter(Type <span class="class"><span class="keyword">type</span>, <span class="title">Annotation</span>[] <span class="title">annotations</span>,</span></div><div class="line">    Retrofit retrofit) &#123;</div><div class="line">        <span class="comment">//在这里实现具体转化逻辑</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Retrofit通过<em>addCallAdapterFactory</em>方法可以支持返回类型<em>Java8</em>或<em>rxjava</em>的处理(也需要添加gradle依赖库)。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">new</span> <span class="selector-tag">Retrofit</span><span class="selector-class">.Builder</span>()</div><div class="line">     <span class="selector-class">.addCallAdapterFactory</span>(<span class="selector-tag">RxJavaCallAdapterFactory</span><span class="selector-class">.create</span>())</div><div class="line">     <span class="selector-class">.addCallAdapterFactory</span>(<span class="selector-tag">RxJava2CallAdapterFactory</span><span class="selector-class">.create</span>()) </div><div class="line">     <span class="selector-class">.build</span>();</div></pre></td></tr></table></figure>
<h2 id="三-封装、整合各框架到项目中去"><a href="#三-封装、整合各框架到项目中去" class="headerlink" title="三. 封装、整合各框架到项目中去"></a>三. 封装、整合各框架到项目中去</h2><p>主要是用LiveData将各框架的数据获取及页面更新，按照MVVM思想整合起来, 使得项目结构符合官方给出的架构图建议，搭建一层逻辑结构，使得更加方便的使用各个组件库。</p>
<p><img src="arch5.png" alt="architecture"></p>
<p>从上到下的逻辑顺序，依次构建各个业务层 需要的逻辑控件：</p>
<h3 id="1-编写需要数据初始化或更新UI的接口方法，并在Observer中更新。"><a href="#1-编写需要数据初始化或更新UI的接口方法，并在Observer中更新。" class="headerlink" title="1.编写需要数据初始化或更新UI的接口方法，并在Observer中更新。"></a>1.编写需要数据初始化或更新UI的接口方法，并在Observer中更新。</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">viewModel</span><span class="selector-class">.getEssayData</span>()<span class="selector-class">.observe</span>(this, new Observer&lt;Resource&lt;ZhihuItemEntity&gt;&gt;() &#123;</div><div class="line">           <span class="variable">@Override</span></div><div class="line">           public void onChanged(<span class="variable">@Nullable</span> Resource&lt;ZhihuItemEntity&gt; essayDayEntityResource) &#123;</div><div class="line">           <span class="comment">//数据源内数据变动后自动回调该接口，然后更新到UI上</span></div><div class="line">                       <span class="selector-tag">updateUI</span>(essayDayEntityResource.data);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div></pre></td></tr></table></figure>
<h3 id="2-构建UI层需要的ViewModel"><a href="#2-构建UI层需要的ViewModel" class="headerlink" title="2.构建UI层需要的ViewModel"></a>2.构建UI层需要的ViewModel</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EssayViewModel</span> <span class="keyword">extends</span> <span class="title">AndroidViewModel</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> EssayRepository mRepository;</div><div class="line">    <span class="keyword">private</span> MediatorLiveData&lt;Resource&lt;ZhihuItemEntity&gt;&gt; mCache;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EssayViewModel</span><span class="params">(Application app)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(app);</div><div class="line">        mRepository = <span class="keyword">new</span> EssayRepository(app);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> LiveData&lt;Resource&lt;ZhihuItemEntity&gt;&gt; getEssayData() &#123;</div><div class="line">        <span class="keyword">if</span> (mCache == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//初始化后，从缓存读取</span></div><div class="line">            mCache = mRepository.loadEssayData();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> mCache;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCache</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> LiveData&lt;Resource&lt;ZhihuItemEntity&gt;&gt; update = mRepository.update();</div><div class="line">        mCache.addSource(update, <span class="keyword">new</span> Observer&lt;Resource&lt;ZhihuItemEntity&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable Resource&lt;ZhihuItemEntity&gt; zhihuItemEntityResource)</span> </span>&#123;</div><div class="line">                mCache.setValue(zhihuItemEntityResource);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMore</span><span class="params">()</span></span>&#123;</div><div class="line">    	<span class="comment">//<span class="doctag">TODO:</span> 加载更多</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-实现Repository类，管理数据获取渠道。"><a href="#3-实现Repository类，管理数据获取渠道。" class="headerlink" title="3.实现Repository类，管理数据获取渠道。"></a>3.实现Repository类，管理数据获取渠道。</h3><p>这里按照官方知道，写了个抽象的数据源类，每次先从本地DB取数据，然后获取网络数据更新到数据库，通过LiveData更新到UI层。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbsDataSource</span>&lt;<span class="title">ResultType</span>, <span class="title">RequestType</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MediatorLiveData&lt;Resource&lt;ResultType&gt;&gt; result = <span class="keyword">new</span> MediatorLiveData&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="meta">@WorkerThread</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">saveCallResult</span><span class="params">(@NonNull RequestType item)</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">shouldFetch</span><span class="params">(@Nullable ResultType data)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">// Called to get the cached getDate from the database</span></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> LiveData&lt;ResultType&gt; <span class="title">loadFromDb</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> LiveData&lt;IRequestApi&lt;RequestType&gt;&gt; createCall();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onFetchFailed</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbsDataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> LiveData&lt;ResultType&gt; dbSource = loadFromDb();</div><div class="line">        result.setValue(Resource.loading(dbSource.getValue()));</div><div class="line"></div><div class="line">        result.addSource(dbSource, <span class="keyword">new</span> Observer&lt;ResultType&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable ResultType resultType)</span> </span>&#123;</div><div class="line">                result.removeSource(dbSource);</div><div class="line">                <span class="keyword">if</span> (shouldFetch(resultType)) &#123;</div><div class="line">                    fetchFromNetwork(dbSource);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    result.addSource(dbSource, <span class="keyword">new</span> Observer&lt;ResultType&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable ResultType resultType)</span> </span>&#123;</div><div class="line">                            result.setValue(Resource.success(resultType));</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fetchFromNetwork</span><span class="params">(<span class="keyword">final</span> LiveData&lt;ResultType&gt; dbSource)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> LiveData&lt;IRequestApi&lt;RequestType&gt;&gt; apiResponse = createCall();</div><div class="line"></div><div class="line">        result.addSource(dbSource, <span class="keyword">new</span> Observer&lt;ResultType&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable ResultType resultType)</span> </span>&#123;</div><div class="line">                result.setValue(Resource.loading(resultType));</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        result.addSource(apiResponse, <span class="keyword">new</span> Observer&lt;IRequestApi&lt;RequestType&gt;&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable <span class="keyword">final</span> IRequestApi&lt;RequestType&gt; requestTypeRequestApi)</span> </span>&#123;</div><div class="line">                result.removeSource(apiResponse);</div><div class="line">                result.removeSource(dbSource);</div><div class="line">                <span class="comment">//noinspection ConstantConditions</span></div><div class="line">                <span class="keyword">if</span> (requestTypeRequestApi.isSuccessful()) &#123;</div><div class="line">                    saveResultAndReInit(requestTypeRequestApi);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    onFetchFailed();</div><div class="line"></div><div class="line">                    result.addSource(dbSource, <span class="keyword">new</span> Observer&lt;ResultType&gt;() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable ResultType resultType)</span> </span>&#123;</div><div class="line">                            result.setValue(</div><div class="line">                                    Resource.error(requestTypeRequestApi.getErrorMsg(), resultType));</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@MainThread</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">saveResultAndReInit</span><span class="params">(<span class="keyword">final</span> IRequestApi&lt;RequestType&gt; response)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Void... voids)</span> </span>&#123;</div><div class="line">                saveCallResult(response.getBody());</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPostExecute</span><span class="params">(Void aVoid)</span> </span>&#123;</div><div class="line">                <span class="comment">// we specially request a new live getDate,</span></div><div class="line">                <span class="comment">// otherwise we will get immediately last cached value,</span></div><div class="line">                <span class="comment">// which may not be updated with latest results received from network.</span></div><div class="line"></div><div class="line">                result.addSource(loadFromDb(), <span class="keyword">new</span> Observer&lt;ResultType&gt;() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChanged</span><span class="params">(@Nullable ResultType resultType)</span> </span>&#123;</div><div class="line">                        result.setValue(Resource.success(resultType));</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;.execute();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> MediatorLiveData&lt;Resource&lt;ResultType&gt;&gt; getAsLiveData() &#123;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-封装Room数据库使用辅助类"><a href="#4-封装Room数据库使用辅助类" class="headerlink" title="4.封装Room数据库使用辅助类"></a>4.封装Room数据库使用辅助类</h3><p>这里二次封装了数据库回调接口，便于多个逻辑模块多数据库的统一管理使用。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">AbsDbCallback</span> &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">create</span>(<span class="params">SupportSQLiteDatabase db</span>)</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">open</span>(<span class="params"></span>)</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">upgrade</span>(<span class="params">SupportSQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion</span>)</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DbCallbackHelper</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;AbsDbCallback&gt; mDbCallbacks = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        mDbCallbacks.<span class="keyword">add</span>(<span class="keyword">new</span> EssayDbCallback());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatchOnCreate</span>(<span class="params">SupportSQLiteDatabase db</span>) </span>&#123;</div><div class="line">        <span class="keyword">for</span> (AbsDbCallback callback : mDbCallbacks) &#123;</div><div class="line">        <span class="comment">//分发onCreate接口</span></div><div class="line">            callback.create(db);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">dispatchUpgrade</span>(<span class="params">SupportSQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion</span>) </span>&#123;</div><div class="line">        <span class="keyword">for</span> (AbsDbCallback callback : mDbCallbacks) &#123;</div><div class="line">            callback.upgrade(db, oldVersion, newVersion);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Migration[] <span class="title">getUpdateConfig</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    	<span class="comment">//每次数据库升级配置这里就可以自动分发到各业务模块的onUpgrade()方法</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Migration[]&#123;</div><div class="line">                <span class="keyword">new</span> Migration(<span class="number">1</span>, <span class="number">2</span>) &#123;</div><div class="line"></div><div class="line">                    @<span class="function">Override</span></div><div class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">migrate</span>(<span class="params">@NonNull SupportSQLiteDatabase database</span>) &#123;</div><div class="line">                        dispatchUpgrade(database, <span class="number">1</span>, <span class="number">2</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="keyword">new</span> Migration(<span class="number">2</span>, <span class="number">3</span>) &#123;</div><div class="line"></div><div class="line">                    @<span class="function">Override</span></div><div class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">migrate</span>(<span class="params">@NonNull SupportSQLiteDatabase database</span>) &#123;</div><div class="line">                        dispatchUpgrade(database, <span class="number">2</span>, <span class="number">3</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-对网络库数据处理的二次封装"><a href="#5-对网络库数据处理的二次封装" class="headerlink" title="5.对网络库数据处理的二次封装"></a>5.对网络库数据处理的二次封装</h3><p>定义一个范型的数据返回接口，便于抽象业务构造及替换网络请求方式。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRequestApi</span>&lt;<span class="title">ResultType</span>&gt; </span>&#123;</div><div class="line">    <span class="function">ResultType <span class="title">getBody</span><span class="params">()</span></span>;</div><div class="line">    <span class="function">String <span class="title">getErrorMsg</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSuccessful</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">....<span class="meta">@WorkerThread</span></div><div class="line">    <span class="keyword">public</span> &lt;ResultType&gt; LiveData&lt;IRequestApi&lt;ResultType&gt;&gt; getEssay(<span class="meta">@EssayWebService</span>.EssayType String type) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        EssayWebService api = mRetrofit.create(EssayWebService.class);</div><div class="line"></div><div class="line">        Call&lt;ZhihuItemEntity&gt; essayCall = api.getZhihuList(<span class="string">"latest"</span>);</div><div class="line">        MediatorLiveData&lt;IRequestApi&lt;ResultType&gt;&gt; result = <span class="keyword">new</span> MediatorLiveData&lt;&gt;();</div><div class="line">        <span class="keyword">final</span> Response&lt;ZhihuItemEntity&gt; response = essayCall.execute();</div><div class="line"></div><div class="line">        IRequestApi&lt;ResultType&gt; requestApi = <span class="keyword">new</span> IRequestApi&lt;ResultType&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function">ResultType <span class="title">getBody</span><span class="params">()</span> </span>&#123;</div><div class="line">                ZhihuItemEntity entity = response.body();</div><div class="line">                <span class="keyword">return</span> (ResultType) entity;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function">String <span class="title">getErrorMsg</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> response.<span class="title">message</span><span class="params">()</span></span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isSuccessful</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="function"><span class="keyword">return</span> response.<span class="title">isSuccessful</span><span class="params">()</span></span>;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        result.postValue(requestApi);</div><div class="line"></div><div class="line"></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>定义一个<em>Resource<t></t></em>的类型包装统一的传递数据，便于UI业务的统一处理。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Resource</span>&lt;<span class="type">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Status &#123;</div><div class="line">        LOADING, MORE_ADD, SUCCEED, ERROR</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@NonNull</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Status status;</div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> T <span class="keyword">data</span>;</div><div class="line">    <span class="meta">@Nullable</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String message;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Resource(<span class="meta">@NonNull</span> Status status, <span class="meta">@Nullable</span> T <span class="keyword">data</span>, <span class="meta">@Nullable</span> String message) &#123;</div><div class="line">        <span class="keyword">this</span>.status = status;</div><div class="line">        <span class="keyword">this</span>.<span class="keyword">data</span> = <span class="keyword">data</span>;</div><div class="line">        <span class="keyword">this</span>.message = message;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> static &lt;T&gt; Resource&lt;T&gt; success(<span class="meta">@NonNull</span> T <span class="keyword">data</span>) &#123;</div><div class="line">        <span class="keyword">return</span> new Resource&lt;&gt;(SUCCEED, <span class="keyword">data</span>, <span class="literal">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> static &lt;T&gt; Resource&lt;T&gt; error(String msg, <span class="meta">@Nullable</span> T <span class="keyword">data</span>) &#123;</div><div class="line">        <span class="keyword">return</span> new Resource&lt;&gt;(ERROR, <span class="keyword">data</span>, msg);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> static &lt;T&gt; Resource&lt;T&gt; loading(<span class="meta">@Nullable</span> T <span class="keyword">data</span>) &#123;</div><div class="line">        <span class="keyword">return</span> new Resource&lt;&gt;(LOADING, <span class="keyword">data</span>, <span class="literal">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> static &lt;T&gt; Resource&lt;T&gt; moreSucceed(<span class="meta">@Nullable</span> T <span class="keyword">data</span>) &#123;</div><div class="line">        <span class="keyword">return</span> new Resource&lt;&gt;(MORE_ADD, <span class="keyword">data</span>, <span class="literal">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>以上二次封装Demo源码已上传<a href="https://github.com/CankingApp/mvvmArch.git" target="_blank" rel="external">GitHub</a>, 有兴趣同学可以学习交流及Star。</p>
<h2 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h2><p>回顾官方的这一套框架结构，其中LivaData个人觉得最重要，她将数据与数据、数据与UI链接在一起，起到了数据的自动管理，解耦多个业务逻辑，是一种优秀的编程思想。</p>
<p>但是LiveData是否是最适合用到android架构开发中取呢？官方给出了这样一句话：</p>
<blockquote>
<p>Note: If you are already using a library like RxJava or Agera, you can continue using them instead of LiveData. But when you use them or other approaches, make sure you are handling the lifecycle properly such that your data streams pause when the related LifecycleOwner is stopped and the streams are destroyed when the LifecycleOwner is destroyed. You can also add the android.arch.lifecycle:reactivestreams artifact to use LiveData with another reactive streams library (for example, RxJava2).</p>
</blockquote>
<p>同样官方没有忽略RxJava的优秀，但是由于个人对RxJava的认识只是查看网络资料了解，并未领略到其威力，有兴趣同学可以了解下。</p>
<blockquote>
<p>RxJava就是一种用Java语言实现的响应式编程，来创建基于事件的异步程序</p>
</blockquote>
<p>优秀的框架重在学习其独特的思想，了解其基本实现原理，然后转化为自己的编程思想。个人觉的这个过程是很缓慢的，只有不断的感悟不同的优秀框架，慢慢的才能产生质变。</p>
<hr>
<p>欢迎转载，请标明出处：常兴E站 <a href="http://www.canking.win">canking.win</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.canking.win/2017/12/09/mvvm/" data-id="cjfgo7lk0000ji03klkz9y6ju" class="article-share-link">分享</a><div class="tags"><a href="/tags/android/">android</a></div><div class="post-nav"><a href="/2017/11/19/gradle-android-res/" class="pre">Gradle插件开发 APK瘦身资源自定义7z压缩</a><a href="/2018/01/07/dy-load/" class="next">安卓平台中的动态加载技术分析</a></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><span class="donate_txt"><br>		   Enjoy it ? Donate me :  免费分享，共同成长</span><br></div><div id="donate_guide" class="donate_bar center hidden"><a id="donate_weixin" href="http://www.canking.win/images/weixin.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/weixin.jpg" fuck="微信打赏"></a><a id="donate_zhifubao" href="http://www.canking.win/images/zhifubao.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/zhifubao.jpg" fuck="支付宝打赏"></a></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
$('#donate_board').addClass('hidden');
$('#donate_guide').removeClass('hidden');
}</script></div><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-4889224929687616",
enable_page_level_ads: true
});

</script></script><div id="uyan_frame"></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136494"></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://www.canking.win"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">19</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design-patterns/">design patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Charles/" style="font-size: 15px;">Charles</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/smart-update/" style="font-size: 15px;">smart update</a> <a href="/tags/JobQueue/" style="font-size: 15px;">JobQueue</a> <a href="/tags/float-permission/" style="font-size: 15px;">float permission</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/theme/" style="font-size: 15px;">theme</a> <a href="/tags/Plugin/" style="font-size: 15px;">Plugin</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/Material-Design/" style="font-size: 15px;">Material Design</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/source-code/" style="font-size: 15px;">source code</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/03/30/sharedpref/">你最了解的 SharedPreference和ContentProvider 知多少？</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/03/20/mem-oom/">Java内存问题 及 LeakCanary 原理分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/07/dy-load/">安卓平台中的动态加载技术分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/mvvm/">Lifecycle+Retrofit+Room完美结合 领略架构之美</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/gradle-android-res/">Gradle插件开发 APK瘦身资源自定义7z压缩</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/minipay/">免sdk实现微信／支付宝转账打赏功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/03/charles-map/">知识总结之 Charles抓包工具使用总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/design-ui/">知识总结之 Material Design库常用控件总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/plugin-hook/">知识总结之 插件化学习 Hook系统方法分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/plugin-activity-loader/">知识总结之 插件化 占坑类Activity实现方式分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.canking.win/fitness" title="健美计步器" target="_blank">健美计步器</a><ul></ul><a href="http://www.canking.win/chargehelper" title="充电助手" target="_blank">充电助手</a><ul></ul><a href="http://sudoku.strikingly.com/" title="爱我数独" target="_blank">爱我数独</a><ul></ul><a href="http://stopwatch.strikingly.com/" title="精确秒表" target="_blank">精确秒表</a><ul></ul><a href="http://www.wandoujia.com/apps/net.canking.gameby" title="色 变" target="_blank">色 变</a><ul></ul><a href="http://canking.strikingly.com/" title="自我简介" target="_blank">自我简介</a><ul></ul><a href="http://cankingapp.github.io/fitness/h5game/index.html" title="H5 Game" target="_blank">H5 Game</a></div><iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&;fansRow=2&amp;ptype=1&amp;speed=0&amp;skin=1&amp;isTitle=1&amp;noborder=0&isWeibo=1&isFans=1&uid=1894127781&verifier=b6b87527&amp;dpc=1"></iframe></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">常兴 E 站.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> changxing</a> by<a rel="nofollow" target="_blank" href="https://github.com/CankingApp/"> GitHub.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>