<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="做酷的东西, 成为伟大的工程师，写匪夷所思的代码，然后和每个人成为朋友．"><title>知识总结 插件化学习 Activity加载分析 | 常兴 E 站</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">知识总结 插件化学习 Activity加载分析</h1><a id="logo" href="/.">常兴 E 站</a><p class="description">Action Speak Louder Than Words.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/sitemap.xml"><i class="fa fa-rss"> sitemap</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">知识总结 插件化学习 Activity加载分析</h1><div class="post-meta">May 20, 2017<span> | </span><span class="category"><a href="/categories/android/">android</a></span></div><div class="post-content"><p>现在安卓插件化已经很成熟，可以直接用别人开源的框架实现自己项目，但是学习插件化的实现原理是安卓研发工程师加深安卓系统理解的很好途径。</p>
<p><img src="http://wx4.sinaimg.cn/mw690/70e618a5ly1fdx0bvig63j20ku0fm77t.jpg" alt="成都·玉林街头"></p>
<a id="more"></a>
<h1 id="安卓插件化学习-插件Activity加载方式分析"><a href="#安卓插件化学习-插件Activity加载方式分析" class="headerlink" title="安卓插件化学习 插件Activity加载方式分析"></a>安卓插件化学习 插件Activity加载方式分析</h1><p>实现一套插件化项目很容易，但是投入生产环境，却很难。自己以学习为目的，主要分析其实现原理。</p>
<p>在工作和学习过程中虽然用到或了解到多家安卓插件化实现方式及原理，自己并没有动手实现或参与公司插件化的研发，so业余时间从基础做起，总结插件化实现原理，自己亲自动手踩踩坑，实现原理及思路均来自开源项目及互联网。</p>
<!--感谢专专在度厂的技术指导，对于那时刚毕业的第一家公司，有一位好的技术领导，很幸运。专专的插件化项目可以说是业界插件化的里程碑，很赞。-->
<p>本文中首先来分析下插件actibity的加载原理，这里主要以<a href="http://blog.csdn.net/singwhatiwanna" target="_blank" rel="external">任玉刚专专</a>的DL开源项目中插件实现原理为参考，采用静态代理方式，代理类反射调用没有context的Activity。</p>
<h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2><p>假如业界没有插件化的实现思路，如果自己接到一个插件化需求，要求可以动态加载安卓四大组件，这些类可以本地预制zip或是云端下载。</p>
<p><strong>回到原点思考问题，怎么实现呢？</strong></p>
<p>首先想到的肯定是ClassLoader，那边安卓平台的ClassLoader是如何应用呢？可以查看Class源码，发现安卓平台SystemClassLoader是PathClassLoader，具体原理看<a href="http://www.canking.win/2017/05/06/classloader">插件化基础ClassLoader</a>.</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">    * Encapsulates the set of parallel capable loader types.</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> ClassLoader createSystemClassLoader() &#123;</div><div class="line">       <span class="keyword">String</span> classPath = System.getProperty(<span class="string">"java.class.path"</span>, <span class="string">"."</span>);</div><div class="line">       <span class="keyword">String</span> librarySearchPath = System.getProperty(<span class="string">"java.library.path"</span>, <span class="string">""</span>);</div><div class="line"></div><div class="line">       <span class="comment">// String[] paths = classPath.split(":");</span></div><div class="line">       <span class="comment">// URL[] urls = new URL[paths.length];</span></div><div class="line">       <span class="comment">// for (int i = 0; i &lt; paths.length; i++) &#123;</span></div><div class="line">       <span class="comment">// try &#123;</span></div><div class="line">       <span class="comment">// urls[i] = new URL("file://" + paths[i]);</span></div><div class="line">       <span class="comment">// &#125;</span></div><div class="line">       <span class="comment">// catch (Exception ex) &#123;</span></div><div class="line">       <span class="comment">// ex.printStackTrace();</span></div><div class="line">       <span class="comment">// &#125;</span></div><div class="line">       <span class="comment">// &#125;</span></div><div class="line">       <span class="comment">//</span></div><div class="line">       <span class="comment">// return new java.net.URLClassLoader(urls, null);</span></div><div class="line"></div><div class="line">       <span class="comment">// TODO Make this a java.net.URLClassLoader once we have those?</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">PathClassLoader</span>(classPath, librarySearchPath, BootClassLoader.getInstance());</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>查看安卓系统源码中Activity加载方式，会发现也是用ClassLoader完成的。</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;</div><div class="line">       <span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span></div><div class="line"></div><div class="line">       ActivityInfo aInfo = r.activityInfo;</div><div class="line">       <span class="params">...</span><span class="params">...</span></div><div class="line"></div><div class="line">       Activity activity = <span class="built_in">null</span>;</div><div class="line">       try &#123;</div><div class="line">           java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">           activity = mInstrumentation.newActivity(</div><div class="line">                   cl, component.getClassName(), r.intent);</div><div class="line">           StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">           r.intent.setExtrasClassLoader(cl);</div><div class="line">           r.intent.prepareToEnterProcess();</div><div class="line">           <span class="keyword">if</span> (r.state != <span class="built_in">null</span>) &#123;</div><div class="line">               r.state.setClassLoader(cl);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       <span class="keyword">public</span> ClassLoader getClassLoader() &#123;</div><div class="line">       synchronized (this) &#123;</div><div class="line">           <span class="keyword">if</span> (mClassLoader == <span class="built_in">null</span>) &#123;</div><div class="line">               createOrUpdateClassLoaderLocked(<span class="built_in">null</span> <span class="comment">/*addedPaths*/</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> mClassLoader;</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">        <span class="keyword">private</span> <span class="literal">void</span> createOrUpdateClassLoaderLocked(<span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; addedPaths) &#123;</div><div class="line">        <span class="params">...</span><span class="params">...</span></div><div class="line">         <span class="keyword">if</span> (!mIncludeCode) &#123;</div><div class="line">           <span class="keyword">if</span> (mClassLoader == <span class="built_in">null</span>) &#123;</div><div class="line">               StrictMode.ThreadPolicy oldPolicy = StrictMode.allowThreadDiskReads();</div><div class="line">               mClassLoader = ApplicationLoaders.getDefault().getClassLoader(</div><div class="line">                   <span class="string">""</span> <span class="comment">/* codePath */</span>, mApplicationInfo.targetSdkVersion, isBundledApp,</div><div class="line">                   librarySearchPath, libraryPermittedPath, mBaseClassLoader);</div><div class="line">               StrictMode.setThreadPolicy(oldPolicy);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">        </div><div class="line">   &#125;</div><div class="line">   </div><div class="line">    <span class="keyword">public</span> ClassLoader getClassLoader(<span class="built_in">String</span> zip, int targetSdkVersion, <span class="built_in">boolean</span> isBundled,</div><div class="line">                                     <span class="built_in">String</span> librarySearchPath, <span class="built_in">String</span> libraryPermittedPath,</div><div class="line">                                     ClassLoader <span class="keyword">parent</span>) &#123;</div><div class="line">    ClassLoader baseParent = ClassLoader.getSystemClassLoader().getParent();</div><div class="line"></div><div class="line">       synchronized (mLoaders) &#123;</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">parent</span> == <span class="built_in">null</span>) &#123;</div><div class="line">               <span class="keyword">parent</span> = baseParent;</div><div class="line">           &#125;          </div><div class="line">               PathClassLoader pathClassloader = PathClassLoaderFactory.createClassLoader(</div><div class="line">                                                     zip,</div><div class="line">                                                     librarySearchPath,</div><div class="line">                                                     libraryPermittedPath,</div><div class="line">                                                     <span class="keyword">parent</span>,</div><div class="line">                                                     targetSdkVersion,</div><div class="line">                                                     isBundled);</div><div class="line">         <span class="keyword">return</span> pathClassloader;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>这里可以肯定安卓系统加载自己类及应用层类的ClassLoader为PathClassLoader(打log也可以看出)。那么继续分析PathClassLoader看看能不能加载我们自己未安卓应用的类?</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">    * Creates a &#123;@code PathClassLoader&#125; <span class="keyword">that</span> operates <span class="keyword">on</span> two <span class="keyword">given</span></div><div class="line">    * lists <span class="keyword">of</span> files <span class="keyword">and</span> directories. The entries <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">first</span> <span class="built_in">list</span></div><div class="line">    * should be one <span class="keyword">of</span> <span class="keyword">the</span> following:</div><div class="line">    *</div><div class="line">    * &lt;ul&gt;</div><div class="line">    * &lt;li&gt;JAR/ZIP/APK files, possibly containing a <span class="string">"classes.dex"</span> <span class="built_in">file</span> <span class="keyword">as</span></div><div class="line">    * well <span class="keyword">as</span> arbitrary resources.</div><div class="line">    * &lt;li&gt;Raw <span class="string">".dex"</span> files (<span class="keyword">not</span> inside a zip <span class="built_in">file</span>).</div><div class="line">    * &lt;/ul&gt;</div><div class="line">    *</div><div class="line">    * The entries <span class="keyword">of</span> <span class="keyword">the</span> <span class="keyword">second</span> <span class="built_in">list</span> should be directories containing</div><div class="line">    * native library files.</div><div class="line">    *</div><div class="line">    * @param dexPath <span class="keyword">the</span> <span class="built_in">list</span> <span class="keyword">of</span> jar/apk files containing classes <span class="keyword">and</span></div><div class="line">    * resources, delimited <span class="keyword">by</span> &#123;@code File.pathSeparator&#125;, which</div><div class="line">    * defaults <span class="keyword">to</span> &#123;@code <span class="string">":"</span>&#125; <span class="keyword">on</span> Android</div><div class="line">    * @param libraryPath <span class="keyword">the</span> <span class="built_in">list</span> <span class="keyword">of</span> directories containing native</div><div class="line">    * libraries, delimited <span class="keyword">by</span> &#123;@code File.pathSeparator&#125;; may be</div><div class="line">    * &#123;@code null&#125;</div><div class="line">    * @param parent <span class="keyword">the</span> parent <span class="built_in">class</span> loader</div><div class="line">    */</div><div class="line">   public PathClassLoader(String dexPath, String libraryPath,</div><div class="line">           ClassLoader parent) &#123;</div><div class="line">       super(dexPath, null, libraryPath, parent);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>根据注释，该类可以加载jar/zip/apk等压缩包里的dex，自己动手写代码验证下。答案肯定是可以的。</p>
<p>PathClassLoader没有接口可以设置优化后的dex防止地方，默认情况会用dexPath充当，这样的话会有很多现在那我们想自定义优化类path怎么办？</p>
<p>看PathClassLoader的父类BasedexClassLoader会发现，它还有个双胞胎弟弟DexClassLoader，为什么说是双胞胎呢？应为这两个类自己都是啥事都没敢，只是实现接口不太一样，而DexClassLoader为我们提供了优化后dex缓存path，实用更灵活。</p>
<p>但是网上有很多地方说PathClassLoader类只能加载已经按照的应用类，不能加载外部未按照的类。并且有人说art虚拟机不行和dalvik虚拟机可以。根据自己亲自实验，PathClassLoader也是可以加载成功的，<br>只是dexOutputPath用了默认的路径会有些限制，至于网上很多不一样的说法，个人理解可能不同的虚拟机实现或是不同系统版本可能有兼容性，未找到官方权威说法。</p>
<h2 id="反射一个Activity"><a href="#反射一个Activity" class="headerlink" title="反射一个Activity"></a>反射一个Activity</h2><p>按照原始问题思路，有了加载压缩包中dex的ClassLoader，那边我们动态加载一个dex中的activity，看看能不能启动一个activity。</p>
<h3 id="1，准备dex包"><a href="#1，准备dex包" class="headerlink" title="1，准备dex包"></a>1，准备dex包</h3><p>写一个简单的apk，包含一个activity，内部做些简单的事情。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">            Button btn = <span class="keyword">new</span> Button(<span class="keyword">this</span>);</div><div class="line">            btn.setText(<span class="string">"This is a plugin's Btn"</span>);</div><div class="line">            setContentView(btn);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="2，创建ClassLoader"><a href="#2，创建ClassLoader" class="headerlink" title="2，创建ClassLoader"></a>2，创建ClassLoader</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> DexClassLoader createDexClassLoader(<span class="keyword">String</span> dexPath) &#123;</div><div class="line">        <span class="built_in">File</span> dexOutputDir = context.getDir(<span class="string">"dex"</span>, <span class="number">0</span>);</div><div class="line">        <span class="keyword">this</span>.dexOutputPath = dexOutputDir.getAbsolutePath();</div><div class="line">        DexClassLoader loader = <span class="keyword">new</span> DexClassLoader(dexPath, dexOutputPath, nativeLibDir, context.getClassLoader());</div><div class="line">        <span class="built_in">return</span> loader;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><img src="plugin3.png" alt="效果"></p>
<p>虽然dexOutputPath可以随意自定义，但是还是建议放入/data/data下的应用私有目录中，防止别人修改自己的代码。ClassLoader加载一次最好缓存起来，即加快下次的使用，也解决ClassLoader类隔离问题。</p>
<h3 id="3，反射调用"><a href="#3，反射调用" class="headerlink" title="3，反射调用"></a>3，反射调用</h3><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="class"><span class="keyword">Class</span>&lt;?&gt; <span class="title">clazz</span> = <span class="title">getClassLoader</span>().<span class="title">loadClass</span>("<span class="title">com</span>.<span class="title">canking</span>.<span class="title">plugin</span>.<span class="title">MainActivity</span>");</span></div><div class="line">    Object obj = clazz.newInstance();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">Method</span> <span class="title">method</span> =</span> clazz.getDeclaredMethod(<span class="string">"onCreate"</span>, Bundle.class);</div><div class="line">    <span class="function"><span class="keyword">method</span>.<span class="title">setAccessible</span>(</span><span class="literal">true</span>);</div><div class="line">    <span class="function"><span class="keyword">method</span>.<span class="title">invoke</span>(</span>obj, <span class="keyword">new</span> Bundle());</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    <span class="built_in">Log</span>.e(<span class="string">"changxing"</span>, <span class="string">"load error:"</span> + e.getMessage());</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="然而报错了"><a href="#然而报错了" class="headerlink" title="然而报错了"></a>然而报错了</h3><p>分析：首先反射调用是没问题的，完全可以从自己的压缩包中加载类（activity）。但是在反射调用onCreate时类内部报<em>NullPointerException</em>错误了。</p>
<p>这时发现new Button（this）时，this中的baseContext为null。这里分析，一个正常的activity是什么时候才有Context呢？查看源码找答案。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span>(<span class="params">ActivityClientRecord r, Intent customIntent</span>) </span>&#123;</div><div class="line">  ......</div><div class="line">   Activity activity = <span class="literal">null</span>;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">       	<span class="comment">//反射加载一个activity类</span></div><div class="line">           java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">           activity = mInstrumentation.newActivity(</div><div class="line">                   cl, component.getClassName(), r.intent);</div><div class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          </div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           Application app = r.packageInfo.makeApplication(<span class="literal">false</span>, mInstrumentation);</div><div class="line">       </div><div class="line">           <span class="keyword">if</span> (activity != <span class="literal">null</span>) &#123;</div><div class="line">           	／／为activity构造Context</div><div class="line">               Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">               activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                       r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                       r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                       r.referrer, r.voiceInteractor, window);</div><div class="line">       ......</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">   <span class="function">final <span class="keyword">void</span> <span class="title">attach</span>(<span class="params">Context context, ActivityThread aThread,</span></span></div><div class="line">           Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</div><div class="line">           Application application, Intent intent, ActivityInfo info,</div><div class="line">           CharSequence title, Activity parent, String id,</div><div class="line">           NonConfigurationInstances lastNonConfigurationInstances,</div><div class="line">           Configuration config, String referrer, IVoiceInteractor voiceInteractor,</div><div class="line">           Window window) &#123;</div><div class="line">           <span class="comment">//为Activity的mBaseContext赋值</span></div><div class="line">       attachBaseContext(context);</div><div class="line"></div><div class="line">       mFragments.attachHost(<span class="literal">null</span> <span class="comment">/*parent*/</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span>(<span class="params">Context <span class="keyword">base</span></span>) </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mBase != <span class="literal">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base context already set"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//到这里Activity有了Context属性。</span></div><div class="line">       mBase = <span class="keyword">base</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>正常的的Activity被AMS反射调用，在attach后就有了Context，那我们自己反射的Activity要想有ConText，就要模拟AMS调用方式，构造Context，但是这相当于再写个系统，不可实现，那怎么办？</p>
<p>遇到问题，解决问题。<br>插件中被反射的activity没有了Context，我们可以把主apk的Acitvity的Context传递给插件Acitivity。</p>
<h2 id="形成方案"><a href="#形成方案" class="headerlink" title="形成方案"></a>形成方案</h2><p>有了以上分析，我们可以专门写个主Apk中的Activity，用来处理插件中所需要的变量及资源，也可以调用插件中的部分方法。这样这个类就变成类一个代理类。</p>
<p>这样就形成了DL开源项目中的<strong>静态代理</strong>方式实现的插件方案。进一步动手代码实验，只要activiyt的每个回调接口都能回调到插件中的activity相同方法，并且插件中的对activity的每个设置都能够回调到主apk中代理类处理，<br>这个插件方式就可以完美运行，至少针对目前的Activity没问题。</p>
<p><img src="plugin5.png" alt="效果"></p>
<p>设置主插件Title为插件中Activity名字,让它“更像”插件页面。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> CharSequence <span class="title">getActivityTitle</span>(<span class="params">Context context, String activityName</span>) </span>&#123;</div><div class="line">       <span class="keyword">if</span> (packageInfo.activities != <span class="literal">null</span> &amp;&amp; packageInfo.activities.length &gt; <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (ActivityInfo info : packageInfo.activities) &#123;</div><div class="line">               <span class="keyword">if</span> (info.name.<span class="keyword">equals</span>(activityName)) &#123;</div><div class="line">                   <span class="keyword">return</span> info.loadLabel(context.getPackageManager());</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="string">""</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><em>loadLabel（）</em> 方法需要给加载PackageInfo设置压缩包的sourceDir和publicSourceDir.</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//for activity name</div><div class="line">       packageInfo.applicationInfo.sourceDir = dexPath<span class="comment">;</span></div><div class="line">       packageInfo.applicationInfo.publicSourceDir = dexPath<span class="comment">;</span></div></pre></td></tr></table></figure>
<h2 id="实现总结"><a href="#实现总结" class="headerlink" title="实现总结"></a>实现总结</h2><p>我们回调原点来从基础分析DL项目静态代理方式实现插件的实现过程，回顾下，发现这种方式是最容易想到，那我们为什么没有比DL作者【任玉刚】早点想到并实现呢？答案是：“没有对应的眼界，不够勤快。”<br>用玉刚常说的一句好说就是”这个社会还没到比聪明时代，想进步，就得比别人多用时间“。</p>
<p>静态代理方式虽然可以实现插件方式，但是用起来还是不方便，接下来我们进一步学习插件化，分析hook系统方法动态代理方式的思想的实现。</p>
<p>——————<br>欢迎转载，请标明出处：常兴E站 <a href="http://www.canking.win">www.canking.win</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.canking.win/2017/05/20/plugin-activity/" data-id="cjad9gw3v000ouu3k872da1im" class="article-share-link">分享</a><div class="tags"><a href="/tags/Plugin/">Plugin</a></div><div class="post-nav"><a href="/2017/05/13/symbolic-link/" class="pre">Linux系统中硬链接与软链接</a><a href="/2017/06/01/binder/" class="next">知识总结 插件化学习 Binder机制原理</a></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><span class="donate_txt"><br>		   Enjoy it ? Donate me :  免费分享，共同成长</span><br></div><div id="donate_guide" class="donate_bar center hidden"><a id="donate_weixin" href="http://www.canking.win/images/weixin.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/weixin.jpg" fuck="微信打赏"></a><a id="donate_zhifubao" href="http://www.canking.win/images/zhifubao.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/zhifubao.jpg" fuck="支付宝打赏"></a></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
$('#donate_board').addClass('hidden');
$('#donate_guide').removeClass('hidden');
}</script></div><div id="uyan_frame"></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136494"></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://www.canking.win"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design-patterns/">design patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Charles/" style="font-size: 15px;">Charles</a> <a href="/tags/smart-update/" style="font-size: 15px;">smart update</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/float-permission/" style="font-size: 15px;">float permission</a> <a href="/tags/JobQueue/" style="font-size: 15px;">JobQueue</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/theme/" style="font-size: 15px;">theme</a> <a href="/tags/Plugin/" style="font-size: 15px;">Plugin</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/Material-Design/" style="font-size: 15px;">Material Design</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/source-code/" style="font-size: 15px;">source code</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/gradle-android-res/">Gradle插件开发 APK瘦身资源自定义7z压缩</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/minipay/">免sdk实现微信／支付宝转账打赏功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/03/charles-map/">知识总结之 Charles抓包工具使用总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/design-ui/">知识总结之 Material Design库常用控件总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/plugin-hook/">知识总结之 插件化学习 Hook系统方法分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/plugin-activity-loader/">知识总结之 插件化 占坑类Activity实现方式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/binder/">知识总结 插件化学习 Binder机制原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/plugin-activity/">知识总结 插件化学习 Activity加载分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/13/symbolic-link/">Linux系统中硬链接与软链接</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/12/reflect-proxy/">知识总结之 插件化基础 java反射与代理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.canking.win/fitness" title="健美计步器" target="_blank">健美计步器</a><ul></ul><a href="http://www.canking.win/chargehelper" title="充电助手" target="_blank">充电助手</a><ul></ul><a href="http://sudoku.strikingly.com/" title="爱我数独" target="_blank">爱我数独</a><ul></ul><a href="http://stopwatch.strikingly.com/" title="精确秒表" target="_blank">精确秒表</a><ul></ul><a href="http://www.wandoujia.com/apps/net.canking.gameby" title="色 变" target="_blank">色 变</a><ul></ul><a href="http://canking.strikingly.com/" title="自我简介" target="_blank">自我简介</a><ul></ul><a href="http://cankingapp.github.io/fitness/h5game/index.html" title="H5 Game" target="_blank">H5 Game</a></div><iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&;fansRow=2&amp;ptype=1&amp;speed=0&amp;skin=1&amp;isTitle=1&amp;noborder=0&isWeibo=1&isFans=1&uid=1894127781&verifier=b6b87527&amp;dpc=1"></iframe></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">常兴 E 站.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> changxing</a> by<a rel="nofollow" target="_blank" href="https://github.com/CankingApp/"> Github.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>