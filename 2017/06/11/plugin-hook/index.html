<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="做酷的东西, 成为伟大的工程师，写匪夷所思的代码，然后和每个人成为朋友．"><title>知识总结之 插件化学习 Hook系统方法分析 | 常兴 E 站</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="Bookmark" href="/favicon.ico"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">知识总结之 插件化学习 Hook系统方法分析</h1><a id="logo" href="/.">常兴 E 站</a><p class="description">Action Speak Louder Than Words.</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/sitemap.xml"><i class="fa fa-rss"> sitemap</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">知识总结之 插件化学习 Hook系统方法分析</h1><div class="post-meta">Jun 11, 2017<span> | </span><span class="category"><a href="/categories/android/">android</a></span></div><div class="post-content"><p>这里主要讲的Hook，是利用java上的动态代理实现替换系统某个类，在方法调用过程中，利用反射，插入自己代码逻辑的一种方式。</p>
<p><img src="http://wx1.sinaimg.cn/mw690/70e618a5ly1fgkvk3t37sj20ku0fmgpm.jpg" alt="武汉·黄鹤楼"></p>
<a id="more"></a>
<h1 id="安卓插件化学习-Hook系统服务分析"><a href="#安卓插件化学习-Hook系统服务分析" class="headerlink" title="安卓插件化学习 Hook系统服务分析"></a>安卓插件化学习 Hook系统服务分析</h1><p>Hook技术主要用的是java的动态代理，掌握类动态代理，其实不难理解Hook原理，只不过是找到一个我们需要的Hook点，然后动态代理获取到系统目标类的代理对象，然后就可以在InvocationHandler中对想要修改的方法逻辑插入自己需求逻辑。</p>
<h2 id="一、Hook的必要条件"><a href="#一、Hook的必要条件" class="headerlink" title="一、Hook的必要条件"></a>一、Hook的必要条件</h2><p>根据上一篇中<a href="http://www.canking.win/2017/05/12/reflect-proxy/">Java反射与代理机制</a> 讲的动态代理机制，重要的是两点：</p>
<h3 id="1、Hook对象需要实现一个接口，并且这个接口方法中有我们需要注入代码的目标方法。"><a href="#1、Hook对象需要实现一个接口，并且这个接口方法中有我们需要注入代码的目标方法。" class="headerlink" title="1、Hook对象需要实现一个接口，并且这个接口方法中有我们需要注入代码的目标方法。"></a>1、Hook对象需要实现一个接口，并且这个接口方法中有我们需要注入代码的目标方法。</h3><p>满足这两点，就可以利用<em>newProxyInstance</em>方法构造出目标对象的代理类，并且在代理对象反射调用的时候，可以调用到Handler里面的对应方法invoke方法里面。</p>
<h3 id="2、满足1条件的同时，获取目标Hook对象。"><a href="#2、满足1条件的同时，获取目标Hook对象。" class="headerlink" title="2、满足1条件的同时，获取目标Hook对象。"></a>2、满足1条件的同时，获取目标Hook对象。</h3><p>这点为整个Hook过程中的难点，要想对某个对象的方法Hook，就要得到该类的对象，然后对于系统的类调用，很多情况是不容易获取对象引用的。然后我们可以找一些静态变量(不用获取类实例)或者一些单例类（反正是单例子，肯定就一个），<br>来降低hook的难度及寻求技巧。</p>
<h2 id="二、系统服务层架构简单分析"><a href="#二、系统服务层架构简单分析" class="headerlink" title="二、系统服务层架构简单分析"></a>二、系统服务层架构简单分析</h2><p>想要hook系统服务，就要熟悉系统服务的基本架构，主要是了解应用与系统交互的Binder架构方式，最好要先了解<a href="http://www.canking.win/2017/06/01/binder/">Binder的相关知识</a>。</p>
<p>结合上节讲的Binder，总的来说可以理解系统服务的使用主要理解下面这几点：</p>
<ul>
<li>1.调用getSystemService(serviceName)方法可获取服务对象在本地进程的一个业务逻辑管理类。</li>
<li>2.方法内用到远端对象的，其实是调用了ServiceManager的getService方法，获取Ixxx类或xxxManager（以下用Ixxx代替）的远端Binder实体的一个本地BinderProxy。</li>
<li>3.调用ServiceManager的getService方法获取远端服务的IBinder对象，这个过程需要底层Binder驱动完成IPC通信。</li>
<li>4.有了远端服务的IBinder对象之后，通过Stub类的asInterface方法进行类型转化，获取目标接口对象。</li>
<li>5.系统中的服务获取都是肯定是跨进程的，远端服务都是在system_server进程中的，所以asInterface方法中返回的是Proxy代理对象，也就是本地端的中间者。</li>
<li>6.最后返回的对象其实就是这个Proxy对象，而这个对象内部使用了静态代理方式，内部有一个来自远端的mRemote变量即IBinder对象。然后直接调用方法其实就是调用mRemote的transact方法进行通信了。</li>
</ul>
<h2 id="三、Android系统中常用Hook点"><a href="#三、Android系统中常用Hook点" class="headerlink" title="三、Android系统中常用Hook点"></a>三、Android系统中常用Hook点</h2><p>安卓系统中有很多我们可以直接动态代理的地方，要想了解和发现这些可hook的点，需要我们熟练的通读和理解源码知识、比如应用的启动过程、四大组件的启动过程、Handler源码分析、View绘制流程等一系列基本知识体系。</p>
<h3 id="通用的hook方案来接管系统各类ManagerService"><a href="#通用的hook方案来接管系统各类ManagerService" class="headerlink" title="通用的hook方案来接管系统各类ManagerService"></a>通用的hook方案来接管系统各类ManagerService</h3><p>我们想要获取系统的一个服务都会用到这么一段代码如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">XXXManager manager=(<span class="name">XXXManager</span>)getSystemService(<span class="name">XXX_SERVICE</span>)<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>然后分析getSystemService方法的具体实现，可以发现此类Manager自身系统服务相关方法在应用本地提供的一个代理类，真正的实现方法会同行getService()方法IPC到系统进程。</p>
<p>那么我们分析下安卓源码的实现，<strong>SystemServiceRegistry</strong>提供了本地可类Manager的获取接口，任何找个Manager，分析，比如进入ActivityManager，发现每个方法进步都会调用<br>ActivityManagerNative.getDefault()方法获取远端proxy来IPC系统进程的实现。</p>
<p>其他Manager类似，最终都会通过下面方法，来获取远端对象的Proxy。</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">IBinder b</span> = ServiceManager.getService(<span class="string">"activity"</span>);</div></pre></td></tr></table></figure>
<p>分析到这里，是不是就可以肯定只要我们Hook掉这个本地的代理，就可以骗掉系统远端实现，并在这个代理类中注入我们需求逻辑，那接下来看看这个本地代理的获取源码，符合动态代理要求吗？</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">final</span> class ServiceManager &#123;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> TAG = <span class="string">"ServiceManager"</span>;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> IServiceManager sServiceManager;</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, IBinder&gt; sCache = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;<span class="keyword">String</span>, IBinder&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> IServiceManager getIServiceManager() &#123;</div><div class="line">       <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> sServiceManager;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Find the service manager</span></div><div class="line">       sServiceManager = ServiceManagerNative.asInterface(BinderInternal.getContextObject());</div><div class="line">       <span class="keyword">return</span> sServiceManager;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Returns a reference to a service with the given name.</div><div class="line">    * </div><div class="line">    * @param name the name of the service to get</div><div class="line">    * @return a reference to the service, or &lt;code&gt;null&lt;/code&gt; if the service doesn't exist</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> IBinder getService(<span class="keyword">String</span> name) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           IBinder service = sCache.<span class="built_in">get</span>(name);</div><div class="line">           <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> service;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">return</span> getIServiceManager().getService(name);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">           Log.e(TAG, <span class="string">"error in getService"</span>, e);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * Place a new @a service called @a name into the service</div><div class="line">    * manager.</div><div class="line">    * </div><div class="line">    * @param name the name of the new service</div><div class="line">    * @param service the service object</div><div class="line">    */</div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> addService(<span class="keyword">String</span> name, IBinder service) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           getIServiceManager().addService(name, service, <span class="keyword">false</span>);</div><div class="line">       &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">           Log.e(TAG, <span class="string">"error in addService"</span>, e);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">  </div><div class="line">..........省略</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该类中，主要看有个getService方法，和一个<em>sCache</em> 缓存。</p>
<p>sCache中保存的是远端服务的一个Ibinder对象，很明显他是实现Ibinder接口的， 并且这两个东西都是静态的，意味着我们可以反射调用getService，然后把sCache里的目标Ibinder替换为我们的动态代理对象。</p>
<p><strong>Hook掉这个对象是不是就可以拦截系统方法了呢？</strong> 答案是否定的。</p>
<p>应为这里hook掉的是一个IBinder接口，只是Binder驱动给我们的一个BinderProxy，<em>BinderProxy</em>是Binder内部final类型的类只是实现类IBinder接口，并没有我们需要拦截的方法。</p>
<p>那怎么才能够拦截我们的目标方法呢？ 当然是找到有这些方法的接口类，比如：IActivityManager、IServiceManager、IClipboard等…</p>
<p>那么这些接口类是怎么通过Binder驱动返回的BinderProxy对象来转化的呢？ 做过AIDL开发的，应该很熟悉下面代码</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//参数就是返回的BinderProxy</span></div><div class="line">....<span class="keyword">public</span> <span class="keyword">static</span> <span class="function">Ixxx <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span>(obj == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               IInterface iin = obj.queryLocalInterface(<span class="string">"android.app.Ixxx"</span>);</div><div class="line">               <span class="keyword">return</span> (Ixxx)(iin != <span class="keyword">null</span> &amp;&amp; iin <span class="keyword">instanceof</span> Ixxx?(Ixxx)iin:<span class="keyword">new</span> Ixxx.Stub.Proxy(obj));</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>可以看出，只要obj.queryLocalInterface返回不为null，就会返回这个方法里的内容给外界调用的地方（即Ixx类的接口赋值）。</p>
<p>而<strong>queryLocalInterface</strong>方法又正好是IBinder接口中的方法，那么我们已经Hook掉的BinderProxy，再次hook掉<em>BinderProx</em>y的<em>queryLocalInterface()</em>方法，就可以完全替换系统层Ixx<br>类的远端服务的本地代理接口。</p>
<p>关键代码如下：</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">Override</span></div><div class="line"><span class="keyword">public</span> Object invoke(Object proxy, <span class="function"><span class="keyword">Method</span> <span class="title">method</span>, <span class="title">Object</span>[] <span class="title">args</span>) <span class="title">throws</span> <span class="title">Throwable</span> <span class="comment">&#123;</span></span></div><div class="line">........if("queryLocalInterface".equals(method.getName())&#123;</div><div class="line">............return Proxy.newProxyInstance(getClassLoader(),</div><div class="line">........................................new Class[]&#123;Ixxx&#125;,</div><div class="line">........................................<span class="title">new</span> <span class="title">HookBinderInvocationHandler</span><span class="params">()</span>;</div><div class="line">........&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过以上代码，就可以在<strong>HookBinderInvocationHandler</strong>类中，的invoke方法中连接Ixx接口的所有系统方法，并且注入自己的代码逻辑。</p>
<p>到这里大功告成，通过这种方法，基本上系统方法都可以hook掉。但是有没有别的办法呢？这种在办法至少需要有两个hook点，是否有必要呢？</p>
<p>其实hook是一项技巧活，Hook的次数需要实际情况的而定，要想通过动态代理实现hook，就需要从上面说的两点出发，获取可hook的对象及地点，找这两个点的难易程度决定了整个hook过程的次数及难易程度。</p>
<h3 id="AMS服务的hook分析"><a href="#AMS服务的hook分析" class="headerlink" title="AMS服务的hook分析"></a>AMS服务的hook分析</h3><p>在插件化实现过程中，Hook系统AMS是最基本也是最重要的学习内容, 接管AMS才能定制化相关插件逻辑，为应用层开发解耦。</p>
<p>Hook的技术需要灵活应用，比如AMS的Hook本来可以用上面的通用方法Hook掉，那具体问题具体分析，有没有更加简单的办法呢？ 有！</p>
<p>想要找到AMS精确的hook点，需要对应用的启动有一定了解，可以这篇文章<a href="https://mp.weixin.qq.com/s?__biz=MzIzNDA3MDgwNA==&amp;mid=2649230082&amp;idx=1&amp;sn=3e972c1eaceca02059454c3e4d45cb6d&amp;chksm=f0e75d79c790d46f406b1b4e8a64f96b43c995b9d0427b427403f56710ca58ddb18eb945e4e7&amp;scene=21#wechat_redirect" target="_blank" rel="external">分析AMS远端服务调用机制以及Activity的启动流程</a>。</p>
<p>通用Hook方案中，由于第一次hook无法获取Ixx类的接口对象，所以多了一次hook。然后是不是只要我们一次性获取Ixx类的实例对象，就可以一次Hook完成接管系统服务。</p>
<p><img src="ams.png" alt="AMS"></p>
<p>看下应用启动过程源码及ActivityManager源码，会发现远端代理的获取并没有每次都采用getService，而是采用单例形式保存在一个静态变量里。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ActivityManagerNative.getDefault()</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">       <span class="keyword">protected</span> <span class="function">IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">           IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">               Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">           &#125;</div><div class="line">           IActivityManager am = asInterface(b);</div><div class="line">           <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">               Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> am;</div><div class="line">       &#125;</div><div class="line">   &#125;;</div></pre></td></tr></table></figure>
<p>从上面代码可以看出，这里获取带远端的BinderProxy后，通过asInterface()方法转化成我们的hook目标接口类，并且返回后保存在一个静态变量里。</p>
<p>这样就为我们反射和动态代理这个点提供了方便。</p>
<p><strong>1、使用反射获取这个gDefault里保存的IActivityManager；</strong><br><strong>2、动态代理产生一个代理类，替换掉这个IActivityManager；</strong></p>
<p>代码如下：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">....<span class="keyword">Class</span>&lt;?&gt; activityManagerNativeClass = <span class="keyword">Class</span>.forName(<span class="string">"android.app.ActivityManagerNative"</span>);</div><div class="line"></div><div class="line">....<span class="comment">// 获取 gDefault 这个字段, 想办法替换它</span></div><div class="line">....Field gDefaultField = activityManagerNativeClass.getDeclaredField(<span class="string">"gDefault"</span>);</div><div class="line">....gDefaultField.setAccessible(<span class="keyword">true</span>);</div><div class="line">....Object gDefault = gDefaultField.get(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">....<span class="comment">// 4.x以上的gDefault是一个 android.util.Singleton对象; 我们取出这个单例里面的字段</span></div><div class="line">....<span class="keyword">Class</span>&lt;?&gt; singleton = <span class="keyword">Class</span>.forName(<span class="string">"android.util.Singleton"</span>);</div><div class="line">....Field mInstanceField = singleton.getDeclaredField(<span class="string">"mInstance"</span>);</div><div class="line">....mInstanceField.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">....<span class="comment">// ActivityManagerNative 的gDefault对象里面原始的 IActivityManager对象</span></div><div class="line">....Object rawIActivityManager = mInstanceField.get(gDefault);</div><div class="line"></div><div class="line">....<span class="comment">// 创建一个这个对象的代理对象, 然后替换这个字段, 让我们的代理对象帮忙干活</span></div><div class="line">....<span class="keyword">Class</span>&lt;?&gt; iActivityManagerInterface = <span class="keyword">Class</span>.forName(<span class="string">"android.app.IActivityManager"</span>);</div><div class="line">....Object proxy = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</div><div class="line">       <span class="keyword">new</span> <span class="keyword">Class</span>&lt;?&gt;[] &#123; iActivityManagerInterface &#125;, <span class="keyword">new</span> IActivityManagerHandler(rawIActivityManager));</div><div class="line">....mInstanceField.set(gDefault, proxy);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h2><p>android平台动态代理方式hook系统，首选需要对hook的整理逻辑很熟悉，并且能给灵活找到hook地方，核心规则就是：能获取到要hook点的类对象，然后动态代理替换掉。</p>
<p>通过阅读源码发现，安卓平台架构中，很多地方都是类似的框架，所以我们可以用同样的办法取hook掉系统的其他服务。</p>
<p>——————<br>欢迎转载，请标明出处：常兴E站 <a href="http://www.canking.win">www.canking.win</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.canking.win/2017/06/11/plugin-hook/" data-id="cje0w8t2e000st73kvgghdik1" class="article-share-link">分享</a><div class="tags"><a href="/tags/Plugin/">Plugin</a></div><div class="post-nav"><a href="/2017/06/01/plugin-activity-loader/" class="pre">知识总结之 插件化 占坑类Activity实现方式分析</a><a href="/2017/06/29/design-ui/" class="next">知识总结之 Material Design库常用控件总结</a></div><div class="post-donate"><div id="donate_board" class="donate_bar center"><a id="btn_donate" href="javascript:;" title="打赏" class="btn_donate"></a><span class="donate_txt"><br>		   Enjoy it ? Donate me :  免费分享，共同成长</span><br></div><div id="donate_guide" class="donate_bar center hidden"><a id="donate_weixin" href="http://www.canking.win/images/weixin.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/weixin.jpg" fuck="微信打赏"></a><a id="donate_zhifubao" href="http://www.canking.win/images/zhifubao.jpg" rel="article0" class="fancybox"><img src="http://www.canking.win/images/zhifubao.jpg" fuck="支付宝打赏"></a></div><script type="text/javascript">document.getElementById('btn_donate').onclick = function(){
$('#donate_board').addClass('hidden');
$('#donate_guide').removeClass('hidden');
}</script></div><script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-4889224929687616",
enable_page_level_ads: true
});

</script></script><div id="uyan_frame"></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2136494"></script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://www.canking.win"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Tool/">Tool</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/android/">android</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/design-patterns/">design patterns</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/node/">node</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tool/">tool</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Plugin/" style="font-size: 15px;">Plugin</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/JobQueue/" style="font-size: 15px;">JobQueue</a> <a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/float-permission/" style="font-size: 15px;">float permission</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/theme/" style="font-size: 15px;">theme</a> <a href="/tags/Charles/" style="font-size: 15px;">Charles</a> <a href="/tags/smart-update/" style="font-size: 15px;">smart update</a> <a href="/tags/Material-Design/" style="font-size: 15px;">Material Design</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/source-code/" style="font-size: 15px;">source code</a> <a href="/tags/node/" style="font-size: 15px;">node</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/01/07/dy-load/">安卓平台中的动态加载技术分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/09/mvvm/">Lifecycle+Retrofit+Room完美结合 领略架构之美</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/19/gradle-android-res/">Gradle插件开发 APK瘦身资源自定义7z压缩</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/minipay/">免sdk实现微信／支付宝转账打赏功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/03/charles-map/">知识总结之 Charles抓包工具使用总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/design-ui/">知识总结之 Material Design库常用控件总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/11/plugin-hook/">知识总结之 插件化学习 Hook系统方法分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/plugin-activity-loader/">知识总结之 插件化 占坑类Activity实现方式分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/01/binder/">知识总结 插件化学习 Binder机制原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/20/plugin-activity/">知识总结 插件化学习 Activity加载分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.canking.win/fitness" title="健美计步器" target="_blank">健美计步器</a><ul></ul><a href="http://www.canking.win/chargehelper" title="充电助手" target="_blank">充电助手</a><ul></ul><a href="http://sudoku.strikingly.com/" title="爱我数独" target="_blank">爱我数独</a><ul></ul><a href="http://stopwatch.strikingly.com/" title="精确秒表" target="_blank">精确秒表</a><ul></ul><a href="http://www.wandoujia.com/apps/net.canking.gameby" title="色 变" target="_blank">色 变</a><ul></ul><a href="http://canking.strikingly.com/" title="自我简介" target="_blank">自我简介</a><ul></ul><a href="http://cankingapp.github.io/fitness/h5game/index.html" title="H5 Game" target="_blank">H5 Game</a></div><iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&;fansRow=2&amp;ptype=1&amp;speed=0&amp;skin=1&amp;isTitle=1&amp;noborder=0&isWeibo=1&isFans=1&uid=1894127781&verifier=b6b87527&amp;dpc=1"></iframe></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">常兴 E 站.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> changxing</a> by<a rel="nofollow" target="_blank" href="https://github.com/CankingApp/"> Github.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>